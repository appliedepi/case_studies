{
  "hash": "874c9a1f071752c93df53f780068eca3",
  "result": {
    "markdown": "---\noutput: html_document\neditor_options: \n  chunk_output_type: console\nformat: \n  html: \n    css: webex.css\n    include-after-body: webex.js\n---\n\n\n# Fulton (EN) {#sec-fulton-en}\n\n## Overview {.unnumbered}\n\n\n\n|**Case study characteristics**|      |\n|------------------------------|:-----|\n| **Name**                     |   Fulton County   |\n| **Language**                 |   English   |\n| **Tool**                     |   R   | \n| **Location**                 |   United States   |\n| **Scale**                    |   Local   | \n| **Diseases**                 |   COVID-19   | \n| **Keywords**                 |   COVID-19; SARS-COV-2; Outbreak   | \n| **Technical complexity**|   Intermediate   |\n| **Methodological complexity**|Basic |\n\n\n***Authorship***\\\nOriginal authors:   Alex Spina, Neale Batra, Mathilde Musset, Henry Laurenson-Schafer\\\nData source: Anonymised and jittered data provided by Fulton County for training purposes\\\nAdapted by: Alberto Mateo Urdiales to the case study template\\\n\n\n## Instructions {.unnumbered}\n\n### Getting Help {.unnumbered}\n \nThere are several ways to get help:\n\n1)  Look for the \"hints\" and solutions (see below)\n2)  Post a question in [Applied Epi Community](www.community.appliedepi.org) with reference to this case study\n\n#### Hints and Solutions {.unnumbered}\n\nHere is what the \"helpers\" look like:\n\n\n```{=html}\n<!--\nNOTE: Below is the hint (all within details tags collapsed)\n-->\n```\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 384 512\" style=\"height:1em;width:0.75em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:gold;overflow:visible;position:relative;\"><path d=\"M297.2 248.9C311.6 228.3 320 203.2 320 176c0-70.7-57.3-128-128-128S64 105.3 64 176c0 27.2 8.4 52.3 22.8 72.9c3.7 5.3 8.1 11.3 12.8 17.7l0 0c12.9 17.7 28.3 38.9 39.8 59.8c10.4 19 15.7 38.8 18.3 57.5H109c-2.2-12-5.9-23.7-11.8-34.5c-9.9-18-22.2-34.9-34.5-51.8l0 0 0 0c-5.2-7.1-10.4-14.2-15.4-21.4C27.6 247.9 16 213.3 16 176C16 78.8 94.8 0 192 0s176 78.8 176 176c0 37.3-11.6 71.9-31.4 100.3c-5 7.2-10.2 14.3-15.4 21.4l0 0 0 0c-12.3 16.8-24.6 33.7-34.5 51.8c-5.9 10.8-9.6 22.5-11.8 34.5H226.4c2.6-18.7 7.9-38.6 18.3-57.5c11.5-20.9 26.9-42.1 39.8-59.8l0 0 0 0 0 0c4.7-6.4 9-12.4 12.7-17.7zM192 128c-26.5 0-48 21.5-48 48c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-44.2 35.8-80 80-80c8.8 0 16 7.2 16 16s-7.2 16-16 16zm0 384c-44.2 0-80-35.8-80-80V416H272v16c0 44.2-35.8 80-80 80z\"/></svg>`{=html} Click to read a hint\n\n</summary>\n\n</br>\n\nHere you will see a helpful hint!\n\n</br>\n\n</details>\n\n\n```{=html}\n<!--\nNOTE: Below is the solution (all within details tags collapsed)\n-->\n```\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nebola_linelist %>% \n  filter(\n    age > 25,\n    district == \"Bolo\"\n  )\n```\n:::\n\n\nHere is more explanation about why the solution works.\n\n</br>\n\n</details>\n\n\n```{=html}\n<!--\nNOTE: End of solution\n-->\n```\n\n#### Posting a question in the Community Forum {.unnumbered}\n\n... description here about posting in Community...\n\n\n#### Terms of Use {.unnumbered}\n\nXXXXXXXXXXXXXXXXXXXXX\n\n\n###  Feedback & suggestions {.unnumbered}\n\n-   You can write feedback and suggestions on this case study at the\n    [GitHub issues\n    page](https://github.com/appliedepi/case_studies)\n-   Alternatively email us at:\n    [contact\\@appliedepi.org](mailto:contact@appliedepi.org)\n\n\\pagebreak\n\n### Version and revisions\n\nThe first version was written by Alex Spina, Neale Batra, Mathilde Musset, Henry Laurenson-Schafer in August 2021.\n\n\n| Date    | Changes made | Version| Author| \n|---------|:-------------|-------:|-------|\n|Mar 2024 | Adapted to case study template| 1.1 | Alberto Mateo Urdiales |\n|         |              |        |\n|         |              |        |\n\n\n\\pagebreak\n\n### Guidance {.unnumbered}\n\n#### Background and Objectives of this case study  {.unnumbered}\n\nThis is a an example R-markdown script which demonstrates how to create an automated outbreak situation report for COVID-19 in Fulton county, USA. The data used comes from an anonymised and fake (scrambled) linelist of COVID-19 cases in Fulton county from the beginning of the pandemic (early 2020) until July 2021.\n\nThe overall objective is to create an automatic and dynamic report that shows the COVID-19 epidemiological situation in Fulton County. \n\nIn this case study you will learn:\n\n-   How to import, clean and analyse your data.\\\n-   Carry out descrptive analysis by time, place and person.\\\n-   Use the above to **create an automatic and dynamic report** in word using Rmarkdown.\\\n\nFor the purpose of the case study we separate this by descriptive analysis and visualisation (normally this would be mixed together of course). \nThe visualisation section is organised in to place, time and person. This is to simplify flow for didactic delivery.\\\nAnalysis is loosely based off the monthly [epidemiology reports](https://www.fultoncountyga.gov/covid-19/epidemiology-reports) for Fulton county\\\n\n\n#### Previous level of expertise assumed {.unnumbered}\n\nUsers should have some prior experience with R, including:\n\n  - R basics: Several packages are required for different aspects of analysis with *R*. You will need to install these before starting.\n    We install and load packages using the {pacman} package. Its p_load() command will install packages if necessary and load them for use in the current session. This might prove difficult if you have limited administrative rights for your computer. Making sure your IT-department gives you the correct access can save a lot of headache. See this handbook pages on the basics of installing packages and running R from  network drives (company computers) for more detail. \n    https://epirhandbook.com/r-basics.html#installation\n    https://epirhandbook.com/r-on-network-drives.html#r-on-network-drives\n    \n  - R projects: See Chapter [6 R Projects](https://epirhandbook.com/en/r-projects.html) from the EpiRhandbook\n    \n  - Import and export of data: See Chapter[7 Import and export](https://epirhandbook.com/en/import-and-export.html)\n    \n\n\n#### Preparation for the case study {.unnumbered}\n\n1. Download folder *fulton_en* and extract contents in the local laptop\n2. Open the Rstudio project inside the folder called *fulton_en.Rproj*\n3. Inside the folder you can find the Rmd and the word output (weekly report). You can also find a word template that will be used as the template for the report. The Rmd and the output are there to help you if you struggle, but you should try to recreate these yourself following this case study.\n3. Subfolder *data* contains fulton COVID-19 data needed for the analysis\n4. Subfolder *solution_materials* has a copy of the Rmd document with the solution and a copy Word document with the output requested\n5. Open a new Rmarkdown file in RStudio and save it in the root folder *fulton_en*. If you have any doubts about how to create an Rmarkdown follow the EpiRhandbook instructors [here](https://epirhandbook.com/en/reports-with-r-markdown.html?q=rmar#install-rmarkdown-r-package)\n6. This Rmarkdown file will be the file used throughout the case study and, rendering it will produce the weekly report in word format\n\n\n\n::: {.cell}\n\n:::\n\n\n\n# Import data and cleaning {.unnumbered}\n\n\n## **Step 1: Rmarkdown set up** {.unnumbered}\n\nRemember that this case study is created in Rmarkdown and that code goes within \"chunks\", which is different from a standard R script. The first steps will be to define the language in which you want the report, the default chunk options and to install/load the necessary packages. \n\n\n### **Step 1.1: Define R language** {.unnumbered}\n\nDepending on where you are and how to carried out R installation, your language \"locale\" might be different from the language of the report that you want to produce. For example, a french person might have a french \"locale\". If that is the case, when creating a graph by day of the week, Monday will be displayed as \"lundi\". If that french person wants to create an English report, as for this case study, the language \"locale\" should be changed.\n\nTask: Ensure your \"locale\" is in English and change it into English if it is not.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# To see your language locale\nSys.getlocale()\n\n# To change it into English\nSys.setlocale(\"LC_ALL\", \"English\")\n```\n:::\n\n\n</br>\n\n</details>\n\n\n### **Step 1.2: Default chunk options** {.unnumbered}\n\nChange the default chunk options of your Rmarkdown script to:\n\na) hide all code chunks in the report\nb) do not show messages or warnings\nc) show errors if they appear, but to not stop the rendering\nd) set up the default figure width to 7 and the figure height to 6\ne) to show the figure titles on top of the plots by default\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# hide all code chunks in the output, but show errors \nknitr::opts_chunk$set(echo = FALSE,  # hide all code chunks in output\n                      error = TRUE,  # show errors if they appear, but don't stop (produce the word doc)\n                      warning = FALSE, # do not show warnings in the output word doc \n                      message = FALSE, # do not show  messages in the output word doc\n                      fig.width = 7,         # Figure width\n                      fig.height = 6,        # Figure height\n                      fig.topcaption = TRUE  # show figure titles on top of plot\n                     )\n```\n:::\n\n\n</br>\n\n</details>\n\n\n### **Step 1.3: Install/load packages** {.unnumbered}\n\nInstall the following packages that will be needed to carry out the analysis: officedown, officer, rio, here, skimr, janitor, lubridate, epikit, tidyverse, flextable, sf, scales, gtsummary, labelled, ggspatial, patchwork, apyramid and incidence2.\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ensures the package \"pacman\" is installed\nif (!require(\"pacman\")) {\n     install.packages(\"pacman\") }\n\n# install (if necessary) from CRAN and load packages to be used\npacman::p_load(\n  officedown, # format MS word document output\n  officer,    # add table of contents to output\n  rio,        # importing data  \n  here,       # relative file pathways \n  skimr,      # get overview of data\n  janitor,    # data cleaning and tables\n  lubridate,  # working with dates\n  epikit,     # age_categories() function\n  flextable,  # converting tables to pretty images\n  sf,         # manage spatial data using a Simple Feature format\n  scales,     # define colour schemes for flextables \n  gtsummary,  # summary statistics, tests and regressions \n  labelled,   # create variable labels to be displayed in table outputs\n  ggspatial,  # basemaps and scalebars \n  patchwork,  # combining multiple ggplots \n  apyramid,   # plotting age pyramids \n  tidyverse  # data management and visualization\n\n)\n```\n:::\n\n</br>\n\n</details>\n\n\n\\pagebreak\n\n\n## **Step 2: Data import and exploration** {.unnumbered}\n\n\n### **Step 2.1: Data import** {.unnumbered}\n\na) Import the COVID-19 linelist called *covid_example_data.xlsx* that can be found in the following path: *data/covid_example_data/*. \nb) Import also the csv files named *fulton_population.csv* found in *data/covid_example_data* needed to retrieve the population in Fulton County.\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution code (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist_raw <- rio::import(\n  file = here::here(\"data\", \"covid_example_data\", \"covid_example_data.xlsx\"),\n  which = \"in\"\n)\n\n# import population data by zipcode to calculate incidence\npop <- import(\n     here(\"data\", \"covid_example_data\", \"fulton_population.csv\")\n)\n```\n:::\n\n</br>\n\n</details>\n\n\n### **Step 2.2: Data exploration** {.unnumbered}\n\nExplore the linelist  to understand better the data.\n\n\n\n::: {.webex-check}\n\nQuestion 2.1: How many rows are present in linelist_raw? <div class='webex-radiogroup' id='radio_FPBQQKLDVX'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FPBQQKLDVX\" value=\"\"></input> <span>48</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FPBQQKLDVX\" value=\"\"></input> <span>31</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FPBQQKLDVX\" value=\"answer\"></input> <span>82101</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FPBQQKLDVX\" value=\"\"></input> <span>5</span></label></div>\nQuestion 2.2: How many columns are of class numeric? <div class='webex-radiogroup' id='radio_ZANKEKZXNL'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_ZANKEKZXNL\" value=\"\"></input> <span>8</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_ZANKEKZXNL\" value=\"answer\"></input> <span>4</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_ZANKEKZXNL\" value=\"\"></input> <span>19</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_ZANKEKZXNL\" value=\"\"></input> <span>31</span></label></div>\n\n:::\n\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution code (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# view your whole dataset interactively (in an excel style format)\nView(linelist_raw)\n\n# get mean, median and max values of numeric variables; counts for categorical variables and NAs with summary\nsummary(linelist_raw)\n\n# get information about each variable in a dataset \nskim(linelist_raw)\n\n# view unique values contained in variables - useful for categorical variables\nunique(linelist_raw$case_gender) \n```\n:::\n\n\n</br>\n\n</details>\n\n\n## **Step 3: Data cleaning** {.unnumbered}\n\n\n### **Step 3.1: Create date objects** {.unnumbered}\n\nCreate an object called *surveillance_date* defined as 7 days prior to the reporting date (30 June 2021). Then, create another object rounding it to the closest Wednesday. Create two daily sequences of dates, one as the 14 days prior to the *surveillance_date* and another as 14-28 days prior to the same date. We will use these throughout the case study\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create a date object for the surveillance\n# Minus 7 days from the date of report (see YAML) to account for lag in reporting lab results\nsurveillance_date <- as.Date(\"2021-06-30\") - 7\n\n# create an epiweek object from the date \n# floor_date() rounds down to the closest week here\nsurveillance_week <- floor_date(surveillance_date,\n                          # round by weeks\n                          unit = \"week\", \n                          # define week to start on Wednesday\n                          week_start = 3)\n\n# define recent (past 14 days) and previous (28 to 14 days prior)\nrecent_period   <- seq(surveillance_week  - 13, surveillance_week, by = 1)\nprevious_period <- seq(surveillance_week  - 27, surveillance_week - 14, by = 1)\n\n# define a text label of date range for the recent period (for table headers)\nrecent_period_labels <- str_glue(\n  format(min(recent_period), format = \"%m/%d\"), \n  \"-\", \n  format(max(recent_period), format = \"%m/%d\")\n)\n\n# define text label of date range for previous period (for table headers) \nprevious_period_labels <- str_glue(\n  format(min(previous_period), format = \"%m/%d\"), \n  \"-\", \n  format(max(previous_period), format = \"%m/%d\")\n)\n\n\n# define a label for past 28 days (for table captions)\nfull_period_labels <- str_glue(\n  format(min(previous_period), format = \"%B %d\"), \n  \"-\", \n  format(surveillance_week, format = \"%B %d, %Y\")\n)\n```\n:::\n\n</br>\n\n</details>\n\n### **Step 3.2: Clean column names** {.unnumbered}\nClean the column names ensuring that names do not contain special characters. Rename the following columns from the raw data: \n\n* Date of report (reprt_creationdt_FALSE) to date_report\n* Date of birth (case_dob_FALSE) to date_dob\n* Date of symptom onset (sym_startdt_FALSE) to date_onset\n* Date of positive testing (pos_sampledt_FALSE) to date_positive\n* Date of recovery (sym_resolveddt_FALSE) to date_recovery\n* Date of hospitalisation (hosp_admidt_FALSE)  to date_hospitalized\n* Date of discharge (hosp_dischdt_FALSE) to date_discharge\n* Date of death (died_dt_FALSE) to date_died\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist_raw %>% \n     clean_names() %>% \n     # NEW name = OLD name\n  rename( \n    date_report         = reprt_creationdt_false,      \n    date_dob            = case_dob_false,              \n    date_onset          = sym_startdt_false,\n    date_recovery       = sym_resolveddt_false, \n    date_hospitalized   = hosp_admidt_false,\n    date_discharge      = hosp_dischdt_false,\n    date_died           = died_dt_false,\n    date_positive       = pos_sampledt_false\n    )\n```\n:::\n\n</br>\n</details>\n\n\n### **Step 3.3: Remove duplicated rows** {.unnumbered}\n\nRemove rows that have duplicated information on: patient id, gender and date of birth. Keep duplicates in a separate dataframe.\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 384 512\" style=\"height:1em;width:0.75em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:gold;overflow:visible;position:relative;\"><path d=\"M297.2 248.9C311.6 228.3 320 203.2 320 176c0-70.7-57.3-128-128-128S64 105.3 64 176c0 27.2 8.4 52.3 22.8 72.9c3.7 5.3 8.1 11.3 12.8 17.7l0 0c12.9 17.7 28.3 38.9 39.8 59.8c10.4 19 15.7 38.8 18.3 57.5H109c-2.2-12-5.9-23.7-11.8-34.5c-9.9-18-22.2-34.9-34.5-51.8l0 0 0 0c-5.2-7.1-10.4-14.2-15.4-21.4C27.6 247.9 16 213.3 16 176C16 78.8 94.8 0 192 0s176 78.8 176 176c0 37.3-11.6 71.9-31.4 100.3c-5 7.2-10.2 14.3-15.4 21.4l0 0 0 0c-12.3 16.8-24.6 33.7-34.5 51.8c-5.9 10.8-9.6 22.5-11.8 34.5H226.4c2.6-18.7 7.9-38.6 18.3-57.5c11.5-20.9 26.9-42.1 39.8-59.8l0 0 0 0 0 0c4.7-6.4 9-12.4 12.7-17.7zM192 128c-26.5 0-48 21.5-48 48c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-44.2 35.8-80 80-80c8.8 0 16 7.2 16 16s-7.2 16-16 16zm0 384c-44.2 0-80-35.8-80-80V416H272v16c0 44.2-35.8 80-80 80z\"/></svg>`{=html} Click to read a hint\n\n</summary>\n\n</br>\n\nTo store duplicates in a new dataframe you can use the function get_dupes() from the {janitor} package\n\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n\n</summary>\n\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# get a data frame of all the duplicates. This is mostly to inspect manually, but can be used for analysing those dropped\nduplicates <- linelist %>% \n     get_dupes(pid, case_gender, date_dob)\n\n# find duplicates based on unique ID, gender and date of birth. Only keep the first occurrence \nlinelist <- linelist %>% \n  distinct(pid, case_gender, date_dob, .keep_all = TRUE)\n```\n:::\n\n</br>\n</details>\n\n::: {.webex-check}\n\n\nQuestion 3.2: How many duplicated rows were present in the raw data? <div class='webex-radiogroup' id='radio_NMZOQCDYVT'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_NMZOQCDYVT\" value=\"answer\"></input> <span>28</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_NMZOQCDYVT\" value=\"\"></input> <span>31</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_NMZOQCDYVT\" value=\"\"></input> <span>38</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_NMZOQCDYVT\" value=\"\"></input> <span>124</span></label></div>\n\n:::\n\n\n\n### **Step 3.4: Change column class and remove data inconsistencies** {.unnumbered}\n\nUsing the across() function from {dplyr} make the following:\n\na) Ensure that dates are considered dates by R\nb) Clean date columns dealing with values that are not compatible with the period under analysis (early 2020 to July 2021)\nc) Make the column age of numeric class\nd) Set us NA those with negative ages and missing Date of birth\ne) Make the zip code column a factor class column\n\n\n<details>\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 384 512\" style=\"height:1em;width:0.75em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:gold;overflow:visible;position:relative;\"><path d=\"M297.2 248.9C311.6 228.3 320 203.2 320 176c0-70.7-57.3-128-128-128S64 105.3 64 176c0 27.2 8.4 52.3 22.8 72.9c3.7 5.3 8.1 11.3 12.8 17.7l0 0c12.9 17.7 28.3 38.9 39.8 59.8c10.4 19 15.7 38.8 18.3 57.5H109c-2.2-12-5.9-23.7-11.8-34.5c-9.9-18-22.2-34.9-34.5-51.8l0 0 0 0c-5.2-7.1-10.4-14.2-15.4-21.4C27.6 247.9 16 213.3 16 176C16 78.8 94.8 0 192 0s176 78.8 176 176c0 37.3-11.6 71.9-31.4 100.3c-5 7.2-10.2 14.3-15.4 21.4l0 0 0 0c-12.3 16.8-24.6 33.7-34.5 51.8c-5.9 10.8-9.6 22.5-11.8 34.5H226.4c2.6-18.7 7.9-38.6 18.3-57.5c11.5-20.9 26.9-42.1 39.8-59.8l0 0 0 0 0 0c4.7-6.4 9-12.4 12.7-17.7zM192 128c-26.5 0-48 21.5-48 48c0 8.8-7.2 16-16 16s-16-7.2-16-16c0-44.2 35.8-80 80-80c8.8 0 16 7.2 16 16s-7.2 16-16 16zm0 384c-44.2 0-80-35.8-80-80V416H272v16c0 44.2-35.8 80-80 80z\"/></svg>`{=html} Click to read a hint\n</summary>\n</br>\n\nThe across() allows to apply the same modification to multiple columns in an easy way. So, these two options are equivalent:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Without across()\n\nlinelist <- linelist %>% \n  mutate(date_report = as.Date(date_report)) %>% \n  mutate(date_dob = as.Date(date_dob)) %>% \n  mutate(date_onset = as.Date(date_onset)) %>% \n  mutate(date_hospitalized = as.Date(date_hospitalized)) %>% \n  mutate(date_discharge = as.Date(date_discharge)) %>% \n  mutate(date_died = as.Date(date_died)) %>% \n  mutate(date_positive = as.Date(date_positive))\n\n\n# With across()\n\nlinelist <- linelist %>% \n  mutate(across(.cols = contains(\"date\"), .fns = ~as.Date(.x)))\n```\n:::\n\n\n\nYou can read more about across() in the EpiRhandbook [section](https://epirhandbook.com/en/cleaning-data-and-core-functions.html?q=across#clean_across)\n\n</br>\n</details>\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>% \n  mutate(across(\n    .cols = contains(\"date\"),\n    .fns = ~as.Date(.x)\n  )) %>%\n  \n  # mark as missing onset dates prior to 2020\n  mutate(across(\n    .cols = c(date_report, date_onset, date_hospitalized, date_discharge, date_died),\n    .fns  = ~replace(.x, .x < as.Date(\"2020-01-01\"), NA)\n    )) %>% \n\n  # mark as missing dates after the surveillance_date (for this report) from all date columns\n  mutate(across(\n    .cols = contains(\"date\"),\n    .fns  =  ~replace(.x, .x > surveillance_date, NA)\n    )) %>%\n     \n  # transform age into numeric class\n  mutate(\n    # ensure that age is a numeric variable\n    case_age = as.numeric(case_age),\n    # set those with negative ages and missing DOB to missing \n    # otherwise just leave the age value as is\n          # nb. NA_real_ just ensures the variable class is not changed\n    case_age = if_else(case_age < 0 & is.na(date_dob), NA_real_, case_age)\n  ) %>% \n     \n  # create a factor from a default numeric class\n  mutate(case_zip = as_factor(case_zip)) \n```\n:::\n\n</br>\n</details>\n\n\n::: {.webex-check}\n\n\nQuestion 3.3: Which one of the following could NOT be used to transform the column sym_startdt_FALSE from the raw data frame into a date object? <div class='webex-radiogroup' id='radio_GFPDBBWBAB'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_GFPDBBWBAB\" value=\"\"></input> <span>base::as.Date()</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_GFPDBBWBAB\" value=\"\"></input> <span>lubridate::as_date()</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_GFPDBBWBAB\" value=\"\"></input> <span>lubridate::ymd()</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_GFPDBBWBAB\" value=\"answer\"></input> <span>lubridate::dmy()</span></label></div>\n\n:::\n\n\n### **Step 3.5: Create a column for weeks** {.unnumbered}\n\nCreate a column named \"epiweek\" using the function floor_date() from the {lubridate} package rounding the report date to the nearest week, taking \"Wednesday\" as the start of the week.\n\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>% \n  # create an \"epiweek\" column from the report date. Use floor_date() to round down to the closest week\n  mutate(epiweek = floor_date(date_report,\n                          # round by weeks\n                          unit = \"week\", \n                          # define week to start on Wednesday\n                          week_start = 3)\n  )\n```\n:::\n\n</br>\n</details>\n\n### **Step 3.6: Create time difference columns** {.unnumbered}\n\nIn this step we ask you to create columns with various time differences that will be used later on in the case study. Please, try to create:\n\n*   A column with the number (numeric) of days from date of symptom onset to the date of hospitalization\n*   In this new column, set as missing those cases where the difference is longer than 30 days (interval is too long for the hospitalization to be due to the infection), and those less than 0 (cannot be hospitalized before the symptom onset)\n*   Using the function coalesce() from {dplyr} create a new column for the date of outcome among hospitalized cases, using date of death or date of discharge, depending on whether cases died or not\n*   Create a new column with the length of hospitalization in days, calculated as the time difference between date of hospitalization and the recently created date of outcome. \n*   In this newly created column mark as missing cases in which the difference between the date of hospitalization and the date of death/discharge was longer than 60 days or lower than 0 days\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>%\n     \n  # delay from onset to hospitalization\n  mutate(\n    # calculate time differences\n    days_onset_hosp = as.numeric(date_hospitalized - date_onset),\n    # set those under 0 or over 30 to missing\n    days_onset_hosp = replace(days_onset_hosp, days_onset_hosp < 0, NA),\n    days_onset_hosp = replace(days_onset_hosp, days_onset_hosp > 30, NA)\n  ) %>%\n     \n  # length of hospitalization\n  mutate(\n    # create outcome date based on whether died or was discharged\n    date_outcome = coalesce(date_died, date_discharge),\n    # calculate time difference\n    days_hosp = as.numeric(date_outcome - date_hospitalized),\n    # set those under 0 or over 60 to missing\n    days_hosp = replace(days_hosp, days_hosp < 0, NA),\n    days_hosp = replace(days_hosp, days_hosp > 60, NA)\n  )\n```\n:::\n\n</br>\n</details>\n\n### **Step 3.7: Create age groups** {.unnumbered}\n\nCreate a column with 10 year age groups up until 70 (and 70+ afterwards) using the age_group() function from the package {epikit}. You can also use any other alternative\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>%\n     # create age group variable\n     mutate(\n       age_group = age_categories(case_age,\n        # define break points\n        c(0, 10, 20, 30, 40, 50, 60, 70),\n        # whether last break should be highest category\n        ceiling = FALSE\n     ))\n```\n:::\n\n</br>\n</details>\n\n\n### **Step 3.8: Recode character/categorical columns** {.unnumbered}\n\nRecode the following columns:\n\n\n*   In the column named **died_covid** recode the category \"Under Review\" to \"Unknown\"\n*   In the column named **confirmed_case** recode the category \"Pending\" to \"Unknown\"\n*   Force categorical columns to use consistent cases \n*   Across character/factor columns recode the category \"Unk\" to \"Unknown\"\n*   Across the different character/factor columns recode NA to \"Unknown\"\n*   In the column named **sym_resolved** recode categories into \"Yes\", \"No\" or \"Unknown\"\n*   Transform the gender column into a factor with these levels: \"Female\", \"Male\" and \"Unknown\"\n*   Transform all columns that have the categories: \"Yes\", \"No\" and \"Unknown\" into factors with the order of the levels as \"Yes\", \"No\" and \"Unknown\"\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>% \n     \n     # recode one value and leave the rest as they are \n     mutate(\n       died_covid = if_else(died_covid == \"Under Review\",\n                            \"Unknown\", died_covid), \n       confirmed_case = if_else(confirmed_case == \"Pending\", \n                                \"Unknown\", confirmed_case), \n     \n        # force categorical variables to use consistent cases (this can be done for others) \n        sym_myalgia = str_to_title(sym_myalgia),\n      ) %>% \n     \n     #replace one value and leave the rest, across multiple variables\n      mutate(across(\n       .cols = c(contact_household, contains(\"sym_\")),\n       .fns  = ~if_else(.x == \"Unk\", \"Unknown\", .x)\n     )) %>% \n     \n        # replace missing with \"Unknown\" where relevant \n     mutate(across(\n       .cols = c(case_gender, case_race, case_eth, case_zip,\n                 contact_id, contact_household, \n                 hospitalized, died, died_covid, confirmed_case,\n                 contains(\"sym_\"), age_group),\n       .fns  = ~fct_na_value_to_level(.x, level = \"Unknown\")\n     )) %>% \n     \n          # recode with searching for string patterns \n     mutate(sym_resolved = case_when(\n          str_detect(sym_resolved, \"Yes\")     ~ \"Yes\", \n          str_detect(sym_resolved, \"No\")      ~ \"No\", \n          str_detect(sym_resolved, \"Unknown\") ~ \"Unknown\", \n          TRUE                                ~ \"Unknown\"\n     )) %>% \n     \n      # set levels of a factor (define order)\n     mutate(case_gender      = fct_relevel(case_gender, \"Female\", \"Male\", \"Unknown\")) %>% \n     \n          # set levels of all factors that are yes/no/unknown \n     mutate(across(\n          .cols = c(contact_household, hospitalized, died, died_covid,\n                    confirmed_case, contains(\"sym_\")), \n          .fns = ~fct_relevel(.x, \"Yes\", \"No\", \"Unknown\")\n     )) \n```\n:::\n\n</br>\n</details>\n\n\n\n### **Step 3.9: Merge ethnicity and race** {.unnumbered}\n\nThe linelist contains a column for ethnicity (**case_eth**) and a column for race (**case_race**). Create a new column merging information from these two existing columns. The new column should:\n\n*   Contain a category \"Hispanic, all races\" when **case_eth** is \"HISPANIC/LATINO\". For those cases where this condition is not met: \n      *   Should have a category for those whose race is \"Asian\", another for those whose race is \"Black\" and another for those whose race is \"White\".\n      *   Create an \"Other\" category for the rest of races and an \"Unknown\" category for those with missing race\n      *   Ensure all categories have consistent cases\n*   Transform the newly formed column into a factor with the \"Unknown\" category as the last level\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\nlinelist <- linelist %>% \n          # create a composite category from race and ethnicitiy  \n     mutate(eth_race = case_when(\n          eth  == \"HISPANIC/LATINO\"                           ~ \"Hispanic, all races\", \n          race == \"ASIAN\"                                     ~ \"Asian, NH\", \n          race == \"BLACK\"                                     ~ \"Black, NH\",\n          race == \"WHITE\"                                     ~ \"White, NH\",\n      # find all instances of NATIVE (covers AMERICAN INDIAN/ALASKA NATIVE **AND** NATIVE HAWAIIAN/PACIFIC ISLANDER)\n          str_detect(race, \"NATIVE\")                          ~ \"Other, NH\",\n          race == \"OTHER\"                                     ~ \"Other, NH\", \n          TRUE                                                ~ \"Unknown\"\n     )) %>% \n     mutate(eth_race = factor(eth_race, levels=c(\n          \"Black, NH\", \"White, NH\", \"Hispanic, all races\",\n          \"Asian, NH\", \"Other, NH\", \"Unknown\"\n     )))\n```\n:::\n\n</br>\n</details>\n\n\n::: {.webex-check}\n\nQuestion 3.4: A column that has ordinal data, what class should it have? <div class='webex-radiogroup' id='radio_WUWSNBPWRN'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_WUWSNBPWRN\" value=\"\"></input> <span>logical</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_WUWSNBPWRN\" value=\"\"></input> <span>character</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_WUWSNBPWRN\" value=\"answer\"></input> <span>factor</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_WUWSNBPWRN\" value=\"\"></input> <span>integer</span></label></div>\n\n:::\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n</details>\n\n\n### **Step 3.10: Filter data frame** {.unnumbered}\n\nFilter the data to keep only confirmed cases whose date of report is not above the date of the report (June 30, 2021). Consider also keeping records with missing date of report.\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n##############       FILTER     ##############        \n\n# store those which do not meet our filter criteria \ndropped <- linelist %>% \n     filter(confirmed_case != \"Yes\" |\n              date_report > surveillance_date & \n                !is.na(date_report))\n\n\n# drop the cases that dont meet the criteria \nlinelist <- linelist %>% \n     filter(confirmed_case == \"Yes\" & \n              date_report <= surveillance_date & \n                 !is.na(date_report))\n```\n:::\n\n</br>\n</details>\n\n\n# Descriptive analysis {.unnumbered}\n\nIn this section we will see how to create an automatic and dynamic report to present a descriptive analysis of the data previously imported and cleaned.\n\n## **Step 4: Start the report with a summary of the findings** {.unnumbered}\n\na) Write in rmarkdown three bullet points summarising the data we imported, showing the number of cases by the date of analysis, the number of hospitalisations and the number of deaths.\n\nb) Write it in a dynamic way, so that the dates and numbers are updated automatically if you get a new updated dataset\n\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\nThis is an example of how the code should look like in your rmarkdown file:\n\n::: {.cell}\n::: {.cell-output-display}\n![](cs/ENG/fulton_en/images/Summary_fulton.png){width=1000px}\n:::\n:::\n\n</br>\n</details>\n\n\\pagebreak\n\n\n## **Step 5. Analysis by time** {.unnumbered}\n\n\n### **Step 5.1: Table weekly number of cases** {.unnumbered}\n\nCreate a table with the number of cases per reporting week to see how the epidemic evolved by time in Fulton County\n\n::: {.webex-check}\n\nQuestion 5.1: During which week do we observe the peak in cases by date of reporting? <div class='webex-radiogroup' id='radio_FHAMAKCUFF'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FHAMAKCUFF\" value=\"\"></input> <span>The week starting on March 02, 2021</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FHAMAKCUFF\" value=\"\"></input> <span>The week starting on December 16, 2020</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FHAMAKCUFF\" value=\"\"></input> <span>The week starting on January 13, 2021</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_FHAMAKCUFF\" value=\"answer\"></input> <span>The week starting on December 30, 2020</span></label></div>\n\n:::\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# save a quick descriptive table of number of cases reported by week\nepiweek_table <- linelist %>% \n  # get counts and percentages \n  tabyl(epiweek) %>% \n  # add the overall counts as a row\n  adorn_totals() %>%  \n  # change from proportions to percentages (do not add a % sign)\n  adorn_pct_formatting(affix_sign = FALSE) \n\n# transform it into flextable for better visualisation\nepiweek_flextable <- epiweek_table %>% \n     qflextable()\n```\n:::\n\n</br>\n</details>\n\n### **Step 5.2: Epicurve** {.unnumbered}\n\nCreate an epicurve by reporting week, with the colour of the bins based on whether the cases were hospitalised or not\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n     # we first define the dataset to be used, the x axis which will be reporting week and the colour (fill) of the bins which will depend on hospitalisation outcome\nggplot(\n     data = linelist,\n     mapping = aes(\n          x = epiweek,\n          fill = hospitalized\n     )) + \n     \n     geom_histogram() + \n     \n     # we define that we want breaks by month and formated with scales::label_date_short()\n     scale_x_date(\n          date_breaks = \"month\",\n          labels = label_date_short()\n     ) +\n     \n     # we change the name of the different elements of the graph\n     labs(\n          x = \"\",\n          y = \"Weekly number of cases\",\n          fill = \"Hospitalised\",\n          caption = paste0(\"Data as of \", format(surveillance_date, \"%d %b %Y\"))\n          \n     ) + \n     \n     # we apply one of the predefined themes\n     theme_bw()\n```\n:::\n\n</br>\n</details>\n\n\n\n\\pagebreak\n\n## **Step 6. Analysis by person** {.unnumbered}\n\n\n### **Step 6.1: Table with demographic information** {.unnumbered}\n\nCreate a table summarising, with counts and percentages, the total cumulative number of cases and deaths, as well the cases and deaths notified in the last 28 days by demographic characteristics: sex, age and race.\n\n::: {.webex-check}\n\nQuestion 6.1: In which age group do we observe the largest proportion of cumulative cases? <div class='webex-radiogroup' id='radio_QOBKTXIMJO'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_QOBKTXIMJO\" value=\"\"></input> <span>0-9</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_QOBKTXIMJO\" value=\"\"></input> <span>30-39</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_QOBKTXIMJO\" value=\"answer\"></input> <span>20-29</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_QOBKTXIMJO\" value=\"\"></input> <span>70+</span></label></div>\nQuestion 6.2: In which race do we observe the largest proportion of deaths in the last 28 days? <div class='webex-radiogroup' id='radio_XUCPVRCAWP'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_XUCPVRCAWP\" value=\"answer\"></input> <span>Black</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_XUCPVRCAWP\" value=\"\"></input> <span>White</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_XUCPVRCAWP\" value=\"\"></input> <span>Asian</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_XUCPVRCAWP\" value=\"\"></input> <span>Hispanic</span></label></div>\n\n:::\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# get counts tables for measures of interest \n############################################\n\n# we generate 3 summary tables and bind them together\n# summary demographic table for gender\ndem_gender <- linelist %>% \n  tabyl(gender) %>% \n  select(Characteristic = gender, n, percent)\n\n# summary demographic table for age\ndem_age <- linelist %>% \n  tabyl(age_group) %>% \n  select(Characteristic = age_group, n, percent)\n\n# summary demographic table for ethnicity and race\ndem_eth_race <- linelist %>% \n  tabyl(eth_race) %>% \n  select(Characteristic = eth_race, n, percent)\n\n# bind all tables together\ntotal_cases <- bind_rows(list(dem_gender, dem_age, dem_eth_race))\n\n# counts of new cases (last 28 days) \nrecent_cases <- purrr::map(\n  # for each variable listed\n  .x = demographic_vars, \n  # filter the linelist for dates on or after 28 days ago\n  .f = ~filter(linelist, \n          date_report >= (surveillance_date - 28)) %>% \n        # get counts based on filtered data\n        tabyl(.x) %>% \n        # nb we dont keep the characteristic column because it would be duplicated\n        select(n_cases_recent = n,\n               perc_cases_recent = percent)\n  ) %>%\n  bind_rows()\n\n# counts of total deaths \ntotal_deaths <- purrr::map(\n  # for each variable listed\n  .x = demographic_vars, \n  # filter for those who died \n  .f = ~filter(linelist, \n          died_covid == \"Yes\") %>% \n        # get counts based on filtered data \n        tabyl(.x, show_na = TRUE) %>%\n        select(n_deaths_total = n, perc_deaths_total = percent)\n  ) %>% \n  bind_rows()\n\n# counts of new deaths (last 28 days)\nrecent_deaths <- purrr::map(\n  # for each variable listed\n  .x = demographic_vars, \n  # filter to those who died in the last 28 days\n  .f = ~filter(linelist, \n          died_covid == \"Yes\" & \n          date_died >= (surveillance_date - 28)) %>% \n        # get counts based on filtered data\n        tabyl(.x) %>% \n        select(n_deaths_recent = n, perc_deaths_recent = percent) %>% \n        # add in a variable column (used for colouring later) \n        mutate(variable = .x)\n  ) %>% \n  bind_rows()\n\n\n# total counts for all of the above measures (not by demographic)\noverall <- linelist %>% \n  summarise(\n    # add in row label \n    Characteristic = \"Total\",\n    # counts of total cases \n    n_cases_total = n(),\n    # leave all percentages empty (would just be 100)\n    perc_cases_total  = NA, \n    # counts of new cases (last 28 days) \n    n_cases_recent = sum(date_report >= (surveillance_date - 28)), \n    perc_cases_recent  = NA, \n    # counts of total deaths \n    n_deaths_total = sum(died_covid == \"Yes\"), \n    perc_deaths_total = NA, \n    # counts of new deaths (last 28 days)\n    n_deaths_recent = sum(died_covid == \"Yes\" & \n                          date_died >= (surveillance_date - 28)),\n    perc_deaths_recent = NA, \n    # add in a variable column (used for colouring later) \n    variable = \"Overall\"\n  )\n\n\n# merge tables together \n#######################\n\n# combine all the demographic tables - side by side\ndemographics_counts <- bind_cols(total_cases, recent_cases, total_deaths, recent_deaths) %>% \n  # mutate each of the proportion columns to be percentages\n  mutate(across(\n    .cols = contains(\"perc\"),\n    .fns = ~round(.x * 100, digits = 1)\n    )) \n# add in the totals row at the top of the merged demographics table\ndemographics_counts <- bind_rows(overall, demographics_counts)\n\n\n# define colour scheme \n######################\n\n# get the column numbers that are percentages (based on the name) \npercentage_cols <- names(demographics_counts) %>% \n  str_detect(\"perc\") %>% \n  which()\n\n# define colour cut-offs for gender column \ngender_colours <- scales::col_bin(\n  # choose colours \n  palette = c(\"#91CF60\", \"#FC8D59\"), \n  # choose min and max (range)\n  domain  = c(0, 100),\n  # choose how to split (in this case above and below 50)\n  bins    = 2\n)\n\n# define colour cut-offs for age column \nage_colours <- scales::col_bin(\n  # choose colours\n  palette = c(\"#91CF60\",\"#FFFFBF\", \"#FC8D59\"),\n  # choose min and max (range)\n  domain  = c(0, 100), \n  # choose cut-off categories \n  bins    = c(0, 5, 20, 100)\n)\n\n# define colour cut-offs for ethnicity column \neth_colours <- scales::col_bin(\n  palette = c(\"#91CF60\",\"#FFFFBF\", \"#FC8D59\"),\n  domain  = c(0, 100), \n  bins    = c(0, 10, 40, 100)\n)\n\n\n# create styled table  \n######################\n\ndemographics_counts %>%\n  # initiate flextable to produce styled output table\n  flextable(\n    # retain variable column for formatting but do not display it\n    col_keys = names(demographics_counts)[-10]\n  ) %>%\n  # redefine column names based on original names\n  set_header_labels(\n    \"n_cases_total\"       = \"Total Confirmed Cases\",\n    \"perc_cases_total\" = \"% of Total Cases\",\n    \"n_cases_recent\"       = \"Confirmed Cases past 28 days\",\n    \"perc_cases_recent\" = \"% of Confirmed Cases past 28 days\",\n    \"n_deaths_total\"       = \"Total Confirmed Deaths\",\n    \"perc_deaths_total\" = \"% of Total Deaths\",\n    \"n_deaths_recent\"       = \"Confirmed Deaths past 28 days\",\n    \"perc_deaths_recent\" = \"% of Confirmed Deaths past 28 days\"\n  ) %>%\n  # move the header text to the centre\n  align(align = \"center\", part = \"header\") %>%\n  # make header text bold\n  bold(part = \"header\") %>%\n  # make the totals row bold (i.e. first row)\n  bold(i = 1, part = \"body\") %>%\n  # fill in the cells\n  # choose the rows with gender counts\n  bg(i = ~variable == \"gender\",\n     # choose the columns with percentages in them\n     j = percentage_cols,\n     # fill in based on previous defined cut-offs\n     bg = gender_colours) %>%\n  bg(i = ~variable == \"age_group\",\n     j = percentage_cols, bg = age_colours) %>%\n  bg(i = ~variable == \"eth_race\",\n     j = percentage_cols, bg = eth_colours) %>%\n  # add horizontal lines after the cells with totals and unknowns\n    # (short-cut to find row ending of each demographic variable)\n  hline(i = ~Characteristic %in% c(\"Total\", \"Unknown\")) %>%\n  # add in footnotes for rows counting unknowns (reference in first column)\n  footnote(i = ~Characteristic == \"Unknown\", j = 1, part = \"body\", ref_symbols = c(\"a\"),\n           value = as_paragraph(\"Unknown includes cases not yet interviewed\")) %>%\n  # add in footnote for deaths counts (ref in the header)\n  footnote(i = 1, j = c(6, 8), part = \"header\", ref_symbols = c(\"b\"),\n           value = as_paragraph(\"Deaths refer to all persons who had a positive PCR test result\n                                for Covid-19 and there is evidence that COVID-19 was the cause of\n                                death or a significant contributor to their death.\")) %>%\n  # make your table fit to the maximum width of the word document\n  set_table_properties(layout = \"autofit\") %>% \n  # decrease the fontsize in the header and body for aesthetic purposes in the document\n  fontsize(part = \"all\", size = 8)\n```\n:::\n\n</br>\n</details>\n\n### **Step 6.2: Age pyramid** {.unnumbered}\n\nCreate an age pyramid with the percentage of cases by age group and sex. \n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# prepare dataset\n\n# start a new dataframe (as dont want to overwrite the original)\nlinelist_2g <- linelist %>% \n  # update the gender and age_group columns\n  mutate(across(.cols = c(gender, age_group), \n                .fns = ~{\n                  # replace \"Unknown\" with NA\n                  .x = na_if(.x, \"Unknown\") \n                  # drop \"Unknown\" from the factor levels \n                  .x = fct_drop(.x)\n                }))\n\n# plot age pyramid \nage_pyramid(\n  data = linelist_2g,\n  age_group = \"age_group\",\n  split_by = \"gender\",\n  # Show as percentages of total cases\n  proportional = TRUE,\n  # remove guide line for mid-point\n  show_midpoint = FALSE) +\n  # set theme to basic \n  theme_minimal() +\n  # add labels \n  labs(\n    title = \"\",\n    subtitle = ,\n    x = \"Age group\",\n    y = \"Percent of total\",\n    fill = \"Gender\",\n    # use str_glue to set dynamic captions \n    # {missing} is defined in the second argument below\n    caption = str_glue(\n      \"{missing} cases missing either age or gender are not shown. \\n Fictional COVID-19 data\",\n      missing = linelist_2g %>%\n        filter(is.na(gender) | is.na(age_group)) %>%\n        nrow()\n      )\n    )\n```\n:::\n\n</br>\n</details>\n\n\n\n\n### **Step 6.3: Scatter plot** {.unnumbered}\n\nCreate a scatter plot showing the relation between age and duration of hospital stay. Colour the points based on whether cases died or not. \n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n#################### C) SCATTER PLOT ####################\n# open a plot with the linelist data\nggplot(data = linelist) +\n  # add points \n  geom_point(\n    mapping = aes(\n      # plot age on the x and days hospitalised on the y axis \n      x = age,\n      y = days_hosp,\n      # color points by outcome\n      color = died),  \n    # all points 3x size\n    size = 3, \n    # opacity of 30% (i.e. relatively see-through)\n    alpha = 0.3) +      \n  # make the x and y axes start at the origin \n  scale_y_continuous(expand = c(0, 0)) + \n  scale_x_continuous(expand = c(0, 0)) + \n  # add in labels \n  labs(\n    x = \"Age (years)\",\n    y = \"Duration (days)\",\n    caption = \"Fulton COVID-19 data\",\n    color = \"Deceased\"\n    ) + \n     theme_bw()\n```\n:::\n\n</br>\n</details>\n\n\n### **Step 6.4: Bar plot** {.unnumbered}\n\nCreate a bar stacked bar plot showing the absolute number of cases by race and vital status\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# open a plot with the linelist data\nggplot(linelist) +\n  # add bars \n  geom_bar(\n    mapping = aes(\n      # plot the number of cases by ethnicity (ordered in reverse frequency)\n      x = fct_rev(fct_infreq(eth_race)),\n      # stack bars and colour by died (ordered in reverse frequency)\n      fill = fct_rev(fct_infreq(died))\n    )\n  ) +\n  # flip the x and y axes \n  coord_flip() +\n  # make the x axes start at the origin (nb axes flipped)\n  scale_y_continuous(expand = c(0, 0), \n                     # define where to label xaxis (nb axes flipped )\n                     breaks = seq(from = 0,\n                                  to = 35000,\n                                  by = 5000)) + \n  # add in labels \n  labs(\n    # set the axes titles (nb axes flipped)\n    x = \"Race and Ethnicity\",\n    y = \"Cases (n)\",\n    caption = \"Fictional COVID-19 data\",\n    fill = \"Deceased\"\n    ) + \n  # apply a defined theme\n     theme_bw()\n```\n:::\n\n</br>\n</details>\n\n\n\\pagebreak\n\n## **Step 7. Analysis by place** {.unnumbered}\n\nCreate a table by zip code in which you show the incidence in the most recent 14 days period, the incidence in the previous 14 days period and the percentage change in incidence between these periods.\n\n::: {.webex-check}\n\nQuestion 7.1: What is the change in incidence observed between periods in the zip code number 30337? <div class='webex-radiogroup' id='radio_EZCBGHVQLL'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_EZCBGHVQLL\" value=\"\"></input> <span>+20%</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_EZCBGHVQLL\" value=\"\"></input> <span>+36%</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_EZCBGHVQLL\" value=\"answer\"></input> <span>-62.5%</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_EZCBGHVQLL\" value=\"\"></input> <span>-25%</span></label></div>\n\n:::\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n################### TABLE BY ZIP CODE\n\nzip_counts <- linelist %>% \n  group_by(zip) %>% \n  # count cases in the appropriate period \n  summarise(\n    recent   = sum(date_report %in% recent_period),\n    previous = sum(date_report %in% previous_period)\n  ) %>% \n  adorn_totals() %>% \n  # a percentage change column and round the digits\n  mutate(\n    perc_change = round((recent - previous) / previous * 100, digits = 1)\n    )\n\n# extract population counts for each zip from the shapefile\nzip_pop <- shapefile %>% \n  # change to tibble (otherwise geo-data gets pulled with)\n  as_tibble() %>% \n  # only keep zip code and population counts\n  select(ZipCode, Population) %>% \n  # add a row with overall counts\n  adorn_totals()\n  \n# merge case counts and population counts\n# zip (or ZipCode in the shapefile) variable is the unique identifier\nzip_counts <- left_join(zip_counts, \n                        zip_pop, \n                        by = c(\"zip\" = \"ZipCode\")\n                        ) %>% \n  # calculate the incidence \n  mutate(across(\n      # for each period (recent and previous)\n      .cols = c(recent, previous), \n      # divide each variable by population (and round the outcome)\n      .fns = ~round(.x / Population * 10000, digits = 1), \n      # for each period create a new variable with _inc on the end\n      .names = \"{.col}_inc\"), \n    \n    # replace NAs in incidence with 0\n    across(\n      .cols = contains(\"inc\"),\n      .fns = ~replace_na(.x, 0)),\n    \n    perc_change = case_when(\n      # fix the outliers: set missing to 0 and infinity (divided by 0) to 100\n      is.na(perc_change)       ~ 0,\n      is.infinite(perc_change) ~ 100, \n      TRUE                     ~ perc_change\n    ))\n\n\n# choose colours to fill in cells  \nrow_colour <- case_when(\n  # those less than zero will be green (decreasing cases)\n  zip_counts$perc_change < 0 ~ \"#91CF60\", \n  # over zero red (increasing)\n  zip_counts$perc_change > 0 ~ \"#FC8D59\", \n  # missing or zero orange\n  TRUE                       ~ \"#FFFFBF\")\n\n\nzip_counts %>% \n  # keep the columns of interest and define order\n  select(zip, recent, recent_inc, previous, previous_inc, perc_change) %>% \n  # initiate {flextable} to produce styled output table\n  flextable() %>% \n  # fill in cells - choose the column and then pass our colour-scheme defined above\n  bg(j = \"perc_change\", \n     bg = row_colour\n     ) %>% \n  # add in a header for labeling counts and incidence by period \n    # note the empty columns (\"\") to fit to the original table headers\n  add_header_row(\n    values = c(\"\", \n               str_c(\"Recent 14-day reporting period\\n\", recent_period_labels), \n               \"\", \n               str_c(\"Previous 14-day reporting period\\n\", previous_period_labels), \n               \"\", \n               \"Change between reporting periods\"\n               )) %>% \n  # redefine column names based on original names\n    # note the different syntax to dplyr::select, here it is old_name = new_name\n  set_header_labels(\n    zip          = \"Zip Code\", \n    recent       = \"n\", \n    recent_inc   = \"Incidence\", \n    previous     = \"n\", \n    previous_inc = \"Incidence\", \n    perc_change  = \"%\"\n  ) %>% \n  # combine the headers cells for the appropriate periods \n  # (i defines rows, j defines columns)\n  merge_at(i = 1, j = 2:3, part = \"header\") %>% \n  merge_at(i = 1, j = 4:5, part = \"header\") %>% \n  # move the header text to the centre\n  align(align = \"center\", part = \"header\") %>% \n  # make header text bold \n  bold(part = \"header\") %>% \n  # make the row with totals in it bold (i.e. the last row in the dataframe)\n  bold(i = nrow(zip_counts), part = \"body\") %>% \n  # add in footnotes for variables (referencing the header cells)\n  footnote(j = c(3, 5), part = \"header\", ref_symbols = c(\"a\"),\n           value = as_paragraph(\"Incidence calculated as cases per 10,000 population by zip code\")) %>% \n  footnote(j = 6, part = \"header\", ref_symbols = c(\"b\"),\n           value = as_paragraph(\"These reflect the percentage increase or decrease of new diagnoses \n                                between the 14 days preceding the past 7 days and the 14 days\n                                preceding that.\")) %>% \n  # make your table fit to the maximum width of the word document\n  set_table_properties(layout = \"autofit\")\n```\n:::\n\n</br>\n</details>\n\n\n# Analysis of mortality {.unnumbered}\n\nIn this section we will show how to include in the report an analysis of the risk factors for Covid-19 mortality.\n\n## **Step 8. Analysis of risk factors for mortality** {.unnumbered}\n\na) Create a table in which you assess, with the appropriate statistical tests, whether the demographic characteristics of those dying from Covid-19 are significantly different from cases who did not die from it.\n\nb) For each of the variables used in the table that you just created, carry out univariate regression using each demographic variable as the independent variable and the outcome (dead, not dead) as the dependent variables. Create a table with the estimates -alongside 95% CI - of the estimates.\n\n::: {.webex-check}\n\nQuestion 8.1: According to the results of the univariate analysis, how was having a sore throat associated with mortality from Covid-19 <div class='webex-radiogroup' id='radio_SZAMRMLRFK'><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_SZAMRMLRFK\" value=\"\"></input> <span>It was a risk factor for mortality</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_SZAMRMLRFK\" value=\"answer\"></input> <span>It was a protective factor for mortality</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_SZAMRMLRFK\" value=\"\"></input> <span>It was not associated with mortality</span></label><label><input type=\"radio\" autocomplete=\"off\" name=\"radio_SZAMRMLRFK\" value=\"\"></input> <span>Impossible to know</span></label></div>\n\n:::\n\n\n<details>\n<summary style=\"text-decoration: underline; color: red;\">\n`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:red;overflow:visible;position:relative;\"><path d=\"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z\"/></svg>`{=html}Click to see a solution (try it yourself first!)\n</summary>\n</br>\n\n::: {.cell}\n\n```{.r .cell-code}\n# define a list of variables for looping over later\nsymptom_vars <- linelist %>% \n     # choose all columns that contain \"sym_\" in the name but exclude \"sym_resolved\"\n     select(c(contains(\"sym_\"), -sym_resolved)) %>% \n     # pull the names out \n     names()\n\n# define variables of interest (save typing them out later) \ndescriptive_vars <- c(\"gender\", \n                      \"age_group\",\n                      \"eth_race\",\n                      symptom_vars,\n                      \"hospitalized\",\n                      \"days_hosp\")\n\n# filter dataset  \nrf_data <- linelist %>% \n  # only keep variables of interest\n  select(died_covid, age, all_of(descriptive_vars)) %>% \n  # set unknown back to NA for all factor variables\n  mutate(across(\n    .cols = where(is.factor),\n    .fns = ~fct_recode(.x, NULL = \"Unknown\"))) %>% \n  # flip factor levels (so that the reference values are correct)\n  mutate(eth_race = fct_infreq(eth_race)) %>% \n  mutate(gender = fct_relevel(gender, \"Female\", \"Male\")) %>% \n  mutate(across(all_of(c(\"died_covid\", symptom_vars, \"hospitalized\")), \n                ~fct_relevel(.x, \"No\", \"Yes\")\n                )) %>% \n  # only keep rows with complete data for all variables of interest\n  # note that this will drop rows where **ANY** of the listed variables are NA\n  drop_na(any_of(c(\"died_covid\", \"age\", descriptive_vars)))\n\n\n# define variable labels to show in output tables \nrf_data <- rf_data %>%\n  set_variable_labels(\n    died_covid = \"Died\",\n    age = \"Age (years)\",\n    gender = \"Gender\",\n    age_group = \"Age group (years)\",\n    eth_race = \"Ethnicity\",\n    sym_fever = \"Fever\",\n    sym_subjfever = \"Subjective fever\",\n    sym_myalgia = \"Myalgia\",\n    sym_losstastesmell = \"Loss taste/smell\",\n    sym_sorethroat = \"Sore throat\",\n    sym_cough = \"Cough\",\n    sym_headache = \"Headache\",\n    hospitalized = \"Hospitalized\",\n    days_hosp = \"Days in hospital\"\n  )\n\n\n\nrf_data %>%\n  # keep variables of interest\n  select(died_covid, gender, eth_race, age, days_hosp) %>%\n  # produce summary table and specify grouping variable\n  tbl_summary(\n    by = died_covid\n  ) %>%\n  # specify what test to perform\n  add_p(\n    list(\n      all_continuous() ~ \"kruskal.test\",\n      eth_race ~ \"kruskal.test\",\n      all_dichotomous() ~ \"chisq.test\"\n    )\n  ) %>%\n  # edit what the column headers say (using {gtsummary})\n  # nb. {n} automatically shows the number in that group and \\n is a linebreak\n  modify_header(update = list(\n    stat_1 ~ \"**Dead**\\n (N={n})\",\n    stat_2 ~ \"**Alive**\\n (N={n})\"\n  )) %>%\n  # edit what it says in the footnote (using {gtsummary})\n  modify_footnote(update = list(\n    all_stat_cols() ~ \"n (%) for categorical;\\n median (IQR) for continuous\",\n    p.value ~ \"Pearson's Chi-squared test for dichotomous;\\n Kruskal-Wallis rank sum test for continuous and categorical\"\n  )) %>%\n  # change to flextable format\n  as_flex_table() %>%\n  # make header text bold (using {flextable})\n  bold(part = \"header\")\n\n###################### B) UNIVARIATE REGRESSION ANALYSIS ####################################\n\n\n# produce table with regression estimates\nregress_tab <- rf_data %>%\n  # drop variables not interested in \n  select(-age_group) %>%\n  # produce univariate table\n  tbl_uvregression(\n    # define outcome variable\n    y = died_covid, \n    # define regression want to run (generalised linear model)\n    method = glm, \n    # define what type of glm want to run (logistic)\n    method.args = list(family = binomial), \n    # exponentiate to produce odds ratios (rather than log odds)\n    exponentiate = TRUE, \n    # do not show the overall counts (this is done in cross_tab below)\n    hide_n = TRUE,\n    ## uncomment this line if you want to not show reference rows\n    # show_single_row = c(symptom_vars, gender, hospitalized),\n    ## note: NULL at the end allows you to have a comma before a commented out row\n    NULL\n  )\n\n# produce table with counts by outcome (using the data fed to the regression above)\ncross_tab <- regress_tab$inputs$data %>%\n  tbl_summary(\n    # group by outcome \n    by = died_covid,\n    ## uncomment this line if you only want to show the \"Male\" row for gender\n    ## this would be run if you also uncommented the single_row in regression above\n    # value = list(gender ~\"Male\"),\n    ## show all levels (otherwise only shows the \"Yes\" level)\n    type = list(all_dichotomous() ~ \"categorical\"),\n    ## note: NULL at the end allows you to have a comma before a commented out row\n    NULL\n  )\n\n# combine tables \ntbl_merge(list(cross_tab, regress_tab)) %>%\n  # edit what it says in the grouping headers \n  modify_spanning_header(update = list(\n    c(\"stat_1_1\",\"stat_2_1\") ~ \"Died\",\n    c(\"estimate_2\", \"ci_2\", \"p.value_2\") ~ \"Univariate regression\")\n    ) %>% \n  # edit what it says in the footnote (using {gtsummary})\n  modify_footnote(update = list(\n    all_stat_cols() ~ \"n (%) for categorical;\\n median (IQR) for continuous\")\n    ) %>% \n  # change to flextable format\n  as_flex_table() %>%\n  # make header text bold (using {flextable})\n  bold(part = \"header\") %>% \n  # make your table fit to the maximum width of the word document\n  set_table_properties(layout = \"autofit\")\n```\n:::\n\n</br>\n</details>\n\n# Interpretation and reflection {.unnumbered}\n\nNow that you have finished this case study, reflect on the different steps taken and how they can be relevant for your day to day work. You may do so by asking yourself the following questions:\n\n\n**Data quality and limitations**\\\n\n-   What was the quality of the COVID-19 raw data imported? How does it compare with the data that you deal with in your job?\\\n-   What were the main limitations of the data on the analysis and interpretation on the COVID-19 outbreak in Fulton? How could data quality be improved?\\\n\n**Analysis**\\\n\n-   Did the case study follow the structure that you would have chosen to create a report in a situation similar to the one in Fulton?\\\n-   Is there any further analysis that you would include in a report like this one? Would you know how to carry it out in R?    \n\n**R code**\\\n\n-   What were the parts of code that you enjoyed the most? And the most challenging?\\ \n-   Do you have the information required to build on what you've learnt?\\\n-   How can you embed what you have learnt in your day to day work?\\\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}