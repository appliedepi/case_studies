{"title":"![](../images/ecdc/logo_epiet_rki.png){width=12in}","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"console"},"execute":{"warning":false,"error":false},"format":{"html":{"css":"webex.css","include-after-body":"webex.js","df-print":"kable"}},"editor":{"markdown":{"wrap":72}},"title":"![](../images/ecdc/logo_epiet_rki.png){width=12in}\n"},"headingText":"An Outbreak of Gastroenteritis in Stegen, Germany (ENG)","headingAttr":{"id":"","classes":["unnumbered"],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n\n## Overview {.unnumbered}\n\n| **Case study characteristics** |                           |\n|--------------------------------|:--------------------------|\n| Name:                          | An Outbreak of Gastroenteritis in Stegen, Germany   |\n| Language:                      | English                   |\n| Tool:                          | R;                         |\n| Location:                      | Germany                   |\n| Scale:                         | Local                  |\n| Diseases:                      | GI                       |\n| Keywords:                      | GI; Stratified analysis; R |\n| Technical complexity:          | Intermediate              |\n| Methodological complexity:     | Basic              |\n# \n\n***Authorship***\\\nOriginal authors: This case study was first designed by Alain Moren and\nGilles Desve for EPIET. It is based on an investigation conducted by\nAnja Hauri, RKI, Berlin, 1998.\\\nData source: Data is fictional and was inspired by [Nygren et al.\nTick-borne encephalitis: acute clinical manifestations and severity in\n581 cases from Germany, 2018-2020. Journal of Infection. 2023 Apr\n1;86(4):369-75](https://linkinghub.elsevier.com/retrieve/pii/S0163-4453(23)00088-9)\\\nAdapted and modified by: Alicia Barrasa (EPIET), Ioannis Karagiannis\n(Public Health England - PHE), Giri Shankar (Public Health Wales),\nNiklas Willrich (Robert Koch Institute-RKI), Patrick Keating (Austrian\nAgency for Health and Food Safety-AGES), Alexander Spina (AGES), Daniel\nGardiner (PHE), Lukas Richter (AGES), Liese Van Gompel (MedEPIET),  Kostas Danis (MedEPIET) and Alberto Mateo Urdiales\n(Istituto Superiore di Sanit√† - ISS)\\\n\n## Instructions\n\n### Getting Help\n\nThere are several ways to get help:\n\n1)  Look for the \"hints\" and solutions (see below)\n2)  Post a question in [Applied Epi\n    Community](www.community.appliedepi.org) with reference to this case\n    study\n\n### Hints and Solutions\n\nHere is what the \"helpers\" look like:\n\n<!--Note that this is the way of including hints and explanations to the solutions -->\n\n```{=html}\n<!--\nNOTE: Below is the hint (all within details tags collapsed)\n-->\n```\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nHere you will see a helpful hint!\n\n</br>\n\n</details>\n\n```{=html}\n<!--\nNOTE: Below is the solution (all within details tags collapsed)\n-->\n```\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\n```{r eval = F, echo=T}\nebola_linelist %>% \n  filter(\n    age > 25,\n    district == \"Bolo\"\n  )\n```\n\nHere is more explanation about why the solution works.\n\n</br>\n\n</details>\n\n```{=html}\n<!--\nNOTE: End of solution\n-->\n```\n<!-- NOTE ABOUT SOLUTIONS: When using {webexercises} the solution will be automatically highlighted, so you can change (if appropriate) the feature \"Click here to see the solution\" to  \"Click here to see the explanation of the solution\" -->\n\n#### Posting a question in the Community Forum\n\n... description here about posting in Community... TO BE COMPLETED BY\nAPPLIED EPI\n\n#### Terms of Use\n\n**Disclaimer**: The information presented in this exercise and the\nassociated data files have been deliberately changed so as to facilitate\nthe acquisition of the learning objectives for fellows of EPIET, EUPHEM\nand EPIET-associated programmes. This case study was first introduced in\n2022 (see Copyright and Licence agreement for more information).\n\nYou are free:\n\n-   to Share: to copy and distribute the work\n-   to Remix: to adapt and build upon the material\n\nUnder the following conditions:\n\n-   Attribution: You must attribute the work in the manner specified by\n    the author or licensor (but not in any way that suggests that they\n    endorse you or your use of the work). The best way to do this is to\n    keep as it is the list of contributors: sources, authors and\n    reviewers.\n\n-   Share Alike: If you alter, transform, or build upon this work, you\n    may distribute the resulting work only under the same or similar\n    license to this one. Your changes must be documented. Under that\n    condition, you are allowed to add your name to the list of\n    contributors.\n\n-   Notification: If you use the work in the manner specified by the\n    author or licensor, [Walter\\@rki.de](mailto:Walterj@rki.de)\n\n-   You cannot sell this work alone but you can use it as part of a\n    teaching.\n\nWith the understanding that:\n\n-   Waiver: Any of the above conditions can be waived if you get\n    permission from the copyright holder.\n\n-   Public Domain: Where the work or any of its elements is in the\n    public domain under applicable law, that status is in no way\n    affected by the license.\n\n-   Other Rights: In no way are any of the following rights affected by\n    the license:\n\n    -   Your fair dealing or fair use rights, or other applicable\n        copyright exceptions and limitations;\n\n    -   The author's moral rights;\n\n    -   Rights other persons may have either in the work itself or in\n        how the work is used, such as publicity or privacy rights.\n\n-   Notice: For any reuse or distribution, you must make clear to others\n    the license terms of this work by keeping together this work and the\n    current license.\n\nThis licence is based on\n<http://creativecommons.org/licenses/by-sa/3.0/>\n\n### Feedback & suggestions\n\n-   You can write feedback and suggestions on this case study at the\n    [GitHub issues page](https://github.com/appliedepi/case_studies)\n-   Alternatively email us at:\n    [contact\\@appliedepi.org](mailto:contact@appliedepi.org)\n\n\\pagebreak\n\n### Version and revisions\n\nWrite date of first version\n\nWrite any revisions made to the case study\n\n| Date | Changes made                                                                                                                                                                                                                                       |                                                                                                                                    Author |\n|---------------------|:-------------------------------|------------------:|\n| 2015 | The case study has been divided in two parts: the first includes descriptive, univariable and stratified analysis as pre-module homework; the second includes logistic and binary regression (not shown here). Unnecessary toponymes were removed. |                                                               Alicia Barrasa (EPIET) and Ioannis Karagiannis (Publich Health England-PHE) |\n| 2017 | Questions were rephrased to reflect real life scenarios (rather than academic exercise)                                                                                                                                                            |                                                                         Alicia Barrasa (EPIET) and Giri Shankar (Public Health Wales-PHW) |\n| 2017 | The case study was adapted to include the help on R                                                                                                                                                                                                | Niklas Willrich (Robert Koch Institute-RKI), Patrick Keating (Austrian Agency for Health and Food Safety-AGES) and Alexander Spina (AGES) |\n|2017| Contribution to the R code|Daniel Gardiner (Public Health England-PHE) and Lukas Richter (AGES)|\n|2022|Minor revisions to the R code and explanations| |\n|2023| Major revision of the R code. R code was simplified and R tidyverse code was implemented| Liese Van Gompel (MedEPIET)|\n|2024| Revision of the R code, i.e. use of EpiStas package for univariable and multivariable analysis, simplification and harmonisation of the R code| Kostas Danis (MediPIET)|\n| 2017 | Revision of content, structure, R code and adaptation of format to Applied Epi's template of case studies | Alberto Mateo Urdiales (ISS) |\n\n\\pagebreak\n\n## Guidance\n\n### Objectives of this case study\n\nAt the end of this case study, participants should:\n\n-   know and be able to perform the fundamental steps of a descriptive statistical analysis of a foodborne outbreak (including quantitative assessment (frequency distributions, missing values, means/medians/modes, quartiles/SDs) and visualization of the data (histogram, boxplot))\n\n-   be able to perform univariate statistical analysis to identify potential vehicles of a foodborne outbreak (including risk ratios and/or odds ratios, depending on the design)\n\n-   know why and how stratification can be conducted in datasets related to an outbreak investigation\n\n-   be able to conduct a stratified analysis with respect to potential risk factors and confounders/effect modifiers\n\n\n### Previous level of expertise assumed\n\nParticipants are expected to be familiar with data management and basic analysis in R.\n\n### Preparation for the case study\n\n1.  Download folder named *stengen_mva* and extract contents in the local\n    laptop\n\n2.  Create an Rstudio project in the folder *stengen_mva* If you are unsure on\n    how to do that, read the EpiRhandbook Chapter on [R\n    projects](https://epirhandbook.com/en/new_pages/r_projects.html)\n\n3.  Inside the folder *stengen_mva*: Subfolder \"data\" contains a raw data\n    file named *tira.csv*. This is the only data file you will use in\n    this case study. In the same folder you can find the **data dictionary** with\n    a description of the dataframe variables.\n    \n4.  Subfolder scripts should be used to save any scripts related to the\n    analysis. Inside \"backup\" you will find a solution script with the\n    code of the case study named *stengen_analysis_backup.R*. \n\n5.  Subfolder \"outputs\" could be used to store all outputs (tables,\n    graphs, documents) that are the result of the analysis\n\n\n# **Part 1 - Scenario, study design and analysis plan**\n## Introduction \n\nOn 26 June 1998, the St Sebastian High School in Stegen (school A), Germany, celebrated a graduation party, where 250 to 350 participants were expected. Attendees included graduates from that school, their families and friends, teachers, 12th grade students and some graduates from a nearby school (school B).\n\nA self-service party buffet was supplied by a commercial caterer in Freiburg. Food was prepared on the day of the party and transported in a refrigerated van to the school.  \n\nFestivities started with a dinner buffet which opened from 8:30 pm onwards and were followed by a dessert buffet offered from 10 pm. The party and the buffet extended late during the night and alcoholic beverages were quite popular. All agreed it was a party to be remembered.\n\n\n## The alert\n\nOn 2nd July 1998, the Freiburg local health office reported to the Robert Koch Institute (RKI) in Berlin the occurrence of many cases of gastroenteritis following the graduation party described above. More than 100 cases were suspected among attendees and some of them were admitted to nearby hospitals. Sick people suffered from fever, nausea, diarrhoea and vomiting that lasted for several days. Most believed that the tiramisu consumed at dinner was responsible for their illness. Salmonella Enteritidis was isolated from 19 stool samples. \n\nThe Freiburg health office sent a team to investigate the kitchen facilities of the caterer. Food preparation procedures were reviewed. Food samples, except tiramisu (none was left over), were sent to the laboratory of Freiburg University. Microbiological analyses were performed on samples of the following: brown chocolate mousse, caramel cream, remoulade sauce, yoghurt dill sauce and 10 raw eggs.  \n \nThe Freiburg health office requested help from the RKI in the investigation to assess the magnitude of the outbreak and identify potential vehicle(s) and risk factors for transmission in order to better control the outbreak.\n\n\n## The study\n\nCases were defined as any person who had attended the party at St Sebastian High School who suffered from diarrhoea (‚â• 3 loose stool for 24 hours) between 27 June and 29 June 1998; or who suffered from at least three of the following symptoms: vomiting, fever ‚â•38.5¬∞C, nausea, abdominal pain, and headache.\n\nStudents from both schools attending the party were asked through phone interviews to provide names of persons who attended the party. \n\nOverall, 291 responded to enquiries and 103 cases were identified (attack rate: 35%). Among these cases, 84 (82%) received medical treatment and four were admitted to hospitals. Attack rates by age group were 36.6% for persons <20 years, 32.1% for persons 20 to 29 years, and 36.8% for persons older than 29 years. \n\n![Figure 1: Cases of gastroenteritis by time of onset among attendees of a high-school graduation ceremony (n=103), Germany, June 1998](../images/stengen/figure1.png)\n\n\n**QUESTION 1**. What would be your hypothesis concerning the source of the outbreak?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\nThe shape of the epidemic curve and the attendance to a single event (a buffet) pointed towards a foodborne outbreak related to a **point source of infection.**\n\n</br>\n\n</details>\n\n\n**QUESTION 2**. What study design would you choose to test this hypothesis?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\nUsing the updated list of attendants, a **retrospective cohort study** including all attendants to the party (that could be reached) was conducted. All had received a standard questionnaire asking for demographic information, signs, symptoms and duration, admission to hospital, and food and beverages consumption at the party including amount consumed. Food-specific attack rates were computed for more than 50 food items and beverages.\n\n\n</br>\n\n</details>\n\n**Question 3**. What would your overall plan of analysis be?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\n**Perform data cleaning**\n\n-   For each variable, look at the range, unexpected and missing values.\n\n-   Correct data using the original forms used if needed \n\n**Describe each variable**\n\n-   For each variable, describe frequency distributions including missing values and, if needed, means, median, modes, quartiles, standard deviation, outliers \n\n-   Make appropriate histograms and box plots\n\n-   Choose relevant characteristics to describe the population\n\n**Identify the outbreak vehicle if any**\n\n-   Calculate food-specific attack rates\n\n-   Look at the proportions of cases exposed\n\n-   Chose the appropriate measure of association\n\n-   Chose the appropriate statistical tests and significance level\n\n-   Calculate the percentages of cases exposed to each exposure\n\n-   Search for any dose-response relationship if appropriate\n\n-   Interpret the results\n\n**Perform a stratified analysis**\n\n-   Identify the variables that are potential effect modifiers (EM) and confounders\n\n-   Design appropriate stratification tables\n\n-   Stratify on each level taken by the EM and confounders\n\n-   Compute appropriate measurements to identify confounding and effect modification\n\n-   Conduct appropriate statistical tests\n\n-   Interpret the results\n\n**Perform a multivariable analysis**\n\n-   This will be discussed during the module.\n\n</br>\n\n</details>\n\n\n\n\n# **Part 2 - Descriptive, univariate and stratified analysis with R**\n\n### **Step 1: Set up**\n\n#### Step 1.1: Create a new R script\n\nOnce you have created an Rproject inside the \"stengen_mva\" folder (as\nspecified in the second point of the section **Preparation for the case\nstudy**). Create a new script with the name *stengen_analysis* and save it in the\nsubfolder \"scripts\". If you are familiar with Rmarkdown, you may decide\nto use this type of file instead of a standard R script.\n\n#### Step 1.2: Define R language\n\nDepending on where you are and how you carried out R installation, your\nlanguage \"locale\" might be different from the language of the graphs\nthat you want to produce. For example, a french person might have a\nfrench \"locale\". If that is the case, when creating a graph by day of\nthe week, Monday will be displayed as \"lundi\". If that french person\nwants to create an English report, as for this case study, the language\n\"locale\" should be changed.\n\n**Task**: Ensure your \"locale\" is in English and change it into English\nif it is not. If you don't know how to do this try finding it online\n(searching for online help is an important skill for R users!).\nOtherwise, see the solution below\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, results = 'hide'}\n# To see your language locale\nSys.getlocale()\n\n# To change it into English\nSys.setlocale(\"LC_ALL\", \"English\")\n\n```\n\n</br>\n\n</details>\n\n#### Step 1.3: Install/load packages\n\nInstall and load the following packages: rio, skimr, janitor, gtsummary,\nrstatix, epitools, epiR, epikit and tidyverse.\n\nYou can find more about installing/loading packages in the\n[Packages](https://epirhandbook.com/en/new_pages/basics.html#packages)\nsection of the EpiRhandbook.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou may end up using a long list of packages. Unfortunately different\npackages have functions with the same name. For example, the package\n{dplyr} (already installed with {tidyverse}) has a function called\n`select()` which we frequently use to subset columns of a data frame.\nBut other packages such as {MASS} do also have a function called\n`select()`. This could create headaches if you want to subset columns\nusing dplyr's `select()` but R thinks you're calling MASS's `select()`\n(we call this masking - `dplyr::select()` is masked by\n`MASS::select()`). Given that you are more likely to use functions from\n{tidyverse}, ensure that this is the last package in your `p_load()`\nlist so that functions from {tidyverse} (including {dplyr} functions)\nwill always \"prevail\".\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, results = 'hide'}\n# Ensures the package \"pacman\" is installed\nif (!require(\"pacman\")) {\n     install.packages(\"pacman\") }\n\npacman::p_load(\n  \n  rio,             # to import datasets\n  skimr,           # for displaying your data\n  janitor,         # a package for data cleaning\n  gtsummary,       # to create frequency tables\n  rstatix,         # to generate summary statistics\n  epitools,        # for univariable analysis\n  epikit,          # for creating age categories\n  epiR,            # for the adjusted risk ratios across strata\n  tidyverse  # data management and visualization\n)\n\n```\n\n</br>\n\n</details>\n\n### **Step 2: Import and explore data**\n\n```{r, include=FALSE}\ntira_raw <- import(\"../case_studies_to_translate/ENG/stengen_mva/data/tira.csv\")\n```\n\n#### Step 2.1: Import the data \n\n**Task** Import the data frame called \"tira.csv\" inside the \"data\" subfolder. \n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nIf you are working within a project, finding the path to the dataframe\nshould be relatively straightfoward. A \".csv\" file is a \"Comma-separated Values\" file.\nYou can import this dataframe using the `read.csv()` which comes already pre-installed in R.\nHowever, we recommend that you use the **`import()`** function\nfrom {rio} because, as you may remember, this function will recognise\nthe file type and import it whether the file is from R, Stata, excel or\nmany others. If you have any doubts about importing review the [Import\nand\nexport](https://epirhandbook.com/en/new_pages/importing.html#import-data)\nchapter of the EpiRhandbook.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, eval=FALSE}\n# Import the dataset 'tira.csv'  \ntira_raw <- import(\"data/tira.csv\") \n```\n\n\n</br>\n\n</details>\n\n\n\n#### Step 2.2: Explore the data \n\n**Task**: Explore the data trying to answer the following questions:\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"522 and 8\",\n  \"2 and 345\",\n  answer = \"291 and 20\",\n  \"600 and 23\"\n)\n\n\ncat(\"QUESTION: How many rows and columns does the dataframe have?\", longmcq(opts))\n\n```\n:::\n\n\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"8\",\n  \"14\",\n  \"1\",\n  \"0\"\n)\n\n\ncat(\"QUESTION: How many cases have 'age' missing?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"factor\",\n  answer = \"integer\",\n  \"character\",\n  \"logical\"\n)\n\n\ncat(\"QUESTION: What is the class of the column 'salmon'?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"83%\",\n  \"70%\",\n  answer = \"29%\",\n  \"6%\"\n)\n\n\ncat(\"QUESTION: What percentage of attendees ate tomato?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"factor\",\n  \"character\",\n  answer = \"date\",\n  \"numeric\"\n)\n\n\ncat(\"QUESTION: What is the class of the column 'dateonset'?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"As 'NA'\",\n  \"As empy spaces\",\n  \"With an 'Unknown' cateogry\",\n  answer = \"With the number 9\"\n)\n\n\ncat(\"QUESTION: How are missing categorised in the variables 'salmon', 'horseradish' and 'pork'?\", longmcq(opts))\n\n```\n:::\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nAn efficient way to explore data is to use the function `skim()` from the {skimr} package, as it gives you all the information needed with only one command. Of course, there are several alternatives. You can also have a look at `glimpse()` from {dplyr}, for example.\nAn easy way to explore single variables that have categories is to use `tabyl()` from {janitor}\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\n# Inspect your dataset and generate basic statistics using the skim function  \nskim(tira_raw)\n# Glimpse is an alternative to skim which gives more accurate information about the nature of the  variables\nglimpse(tira_raw)\n# To see the different categories of the variables\ntabyl(tira_raw, tomato)\n\n```\n\n\n</br>\n\n</details>\n\n\n#### Step 2.3: Explore age in more detail \n\n**Task** Explore the age of attendees by: \n\n- Getting summary statistics\n\n- Generating a boxplot of age by illness status.\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can create a boxplot with {ggplot2} by using the geom `geom_boxplot()`.  In order to create two boxes, one for each illness status, you can assign in the aesthetics the column *ill* to both the x-axis and the fill. Don't worry if it doesn't look good right now....it should look like the solution below. If you need a refresher on how ggplot works, have a look at the EpiRhandbook [Chapter](https://epirhandbook.com/new_pages/ggplot_basics.html)\n\n</br>\n\n</details>\n\n\n\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, warning=TRUE}\n## Generate summary statistics \nsummary(tira_raw$age)\n\n### Creating a boxplot of age by illness status\nboxplot_age <- tira_raw %>% \n  \n  ggplot(mapping = aes(x = ill,\n                       y = age,\n                       fill = ill)) + \n  \n  geom_boxplot() + \n  \n  labs(\n    title = \"Boxplot: Age distribution per illness status\",\n    x = \"Disease status\",\n    y = \"Age\",\n    fill = \"Illness (0=No;1=Yes)\"\n  ) +\n  \n  theme_bw()\n\nboxplot_age\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"No ill\",\n  \"Ill\",\n  answer = \"Impossible to know from this boxplot\"\n)\n\n\ncat(\"QUESTION: Which group (ill or not ill) has more variation around age's median?\", longmcq(opts))\n\n```\n:::\n\nWe were not able to create the boxplot that we aimed for. In fact, you can see that a warning message appeared in your console saying: \"Did you forget to specify a `group` aesthetic or to convert a numerical variable into a factor?\"\n\nLooks like all columns that consist of 1 (present) and 0 (absent) values are of class 'integer', including \"ill\". Integer means that they are considered numbers. However, we want them to be categories, otherwise we won't be able to carry out many of the analysis we want (including this boxplot). So, now we'll sort this out alongside other cleaning operations.  \n\n### **Step 3: Clean the data**\n\n#### Step 3.1: Transform categorical variables\n**Task**: Change all present (1) / absent (0) variables from integer to factors. Do the same for the variables that record the number of portions eaten.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can do this one by one, or you could do all at the same time using the `across()` function from {dplyr}. If you are not sure how to use the `across()` function, read the section on [Transform multiple columns](https://epirhandbook.com/en/new_pages/cleaning.html#clean_across) from the EpiRhandbook.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x)))\n\n\n# Check that the changes have been succesful\nglimpse(tira_clean)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.2: Categorise \"missing\" as NA\nWe saw with the `skim()` overview -and in the data dictionary- that the variables *salmon*, *pork* and *horseradish* have 'missing' codified with number '9'. In most analysis and visualisations, it is very important that R considers missing data truly as \"missing\". To do that, missing data needs to be coded as NA (**without quotes**). Other codifications of missing data, such as empty spaces or the number 9 (as in this case) will mean that R will treat this data as a category or a number. For R, 9 is not different from number 1.\n\n**Task** Recode the columns salmon, pork and horseradish so that values of 9 are coded as NA. Add the new code to the cleaning pipeline initiated in the previous step\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nFor this task you can use the `mutate()` function in combination with `recode()` or `if_else()`. The former is used specifically for recoding, whereas the latter is used to create/modify columns based on logical conditions. In any case, functions like `if_else()` and `recode()` may require you to specify the type of NA (e.g., NA_character_, NA_real_, NA_integer_) to ensure that the resulting vector maintains a consistent data type. This is important because R is strongly typed, meaning that each vector must contain elements of the same type.\nIf you want to know more about recoding, read the EpiRhandbook section on [Recoding](https://epirhandbook.com/new_pages/cleaning.html#re-code-values). Regardless of the approach that you choose, add it to the cleaning pipe command you started before, so that your code is tidy.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_)))\n\n\n# Check that the changes have been succesful\ntabyl(tira_clean, pork)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.3: Re-categorise mousse and tiramisu portions\nWe saw that there are two columns -*tportion* and *mportion*- that have four categories according to the number of portions eaten. However, exploring these columns we can see that few people ate 3 portions. The low number in this category means that it will be very difficult to have meaningful results due to the wide uncertainty that we'll find in the estimates.\n\n**Task**: Re-categorise these columns so that they have three categories: 0,1 and 2+ portions eaten. Add the new code to the cleaning pipeline initiated previously. \n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nWe will now use the `mutate()` function in combination with `if_else()`. As specified above, this function is used for simple logical recoding, which is what we want to do now. There are three \"partner\" functions called `if_else()` from {dplyr}, `ifelse()` from {base} and `fifelse()` from {data.table}. They all have the same syntax. `ifelse()` has the advantage of being embedded in R, which guarantees its stability and sustainability. `if_else()` has some advantages compared to `ifelse()` that are important in epi analysis. For example, it does not convert Date objects to numeric (which can be a headache) and verifies that both alternatives in the if and else statements are of the same class. Finally, `fifelse()` is the fastest, so it has its advantages when we're analysis a large database.\n\nIf you want to know more about simple logical recoding, have a look at the dedicated [section](https://epirhandbook.com/new_pages/cleaning.html#ifelse-and-if_else) of the EpiRhandbook.\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\n#Check portion before\ntabyl(tira_clean, tportion)\ntabyl(tira_clean, mportion)\n\n#Run cleaning pipe line with new code\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_))) %>% \n  \n  # simple logical recoding with if_else()\n  mutate(across(.cols = c(tportion, mportion), .fns = ~if_else(.x == \"3\" | .x == \"2\", \"2+\", .x)))\n\n\n#Check portion after to verify changes\ntabyl(tira_clean, tportion)\ntabyl(tira_clean, mportion)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.4: Create age groups\n\n\n**Task**: Create a new variable with two categories (those aged < age's median and those >=age's median). **Add the code to create this new variable to the cleaning command you created above to ensure your code is tidy. Do not write multiple cleaning commands**\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can  create the age group column with the function `age_categories()` from {epikit}. If you're not familiar with this function, try looking in the *Help* on how it works, or read the specific EpiRhandbook [Section](https://epirhandbook.com/new_pages/cleaning.html#age_categories)\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_))) %>% \n  \n  # simple logical recoding with if_else()\n  mutate(across(.cols = c(tportion, mportion), .fns = ~if_else(.x == \"3\" | .x == \"2\", \"2+\", .x))) %>% \n  \n  # create age categories\n  mutate(age_group = age_categories(age,           # the column to use to create the cateogories \n                                    lower = 0,     # the lower value\n                                    upper = 20,    # the upper value (we want a group of 20+)\n                                    by = 20))      # as we only want two groups, this is also 20\n\n\n\n# Check that the changes have been succesful\ntabyl(tira_clean, age_group)\n```\n\n\n</br>\n\n</details>\n\n\n\n\n\n#### Step 3.5: Re-create the boxplot\n**Task**: Create the boxplot we tried in **Step 2.3** using the clean version of the data. Save the boxplot in the subfolder \"outputs\".\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n## Boxplot of age by illness status\nboxplot_age <- tira_clean %>% \n  \n  ggplot(mapping = aes(x = ill,\n                       y = age,\n                       fill = ill)) + \n  \n  geom_boxplot() + \n  \n  labs(\n    title = \"Boxplot: Age distribution per disease status\",\n    x = \"Disease status\",\n    y = \"Age\",\n    fill = \"Illness (0=No;1=Yes)\"\n  ) +\n  \n  theme_bw()\n\nboxplot_age\n```\n\n```{r, echo=TRUE, eval=FALSE}\n\n### Save the boxplot\n#### A static way of saving it\nggsave(filename = \"outputs/boxplot_age.png\", plot = boxplot_age)\n#### A dynamic way of doing it so that it contains the date of the analysis\nggsave(filename = str_glue(\"outputs/boxplot_age_\",             #First we write the beginning of the file name until the date \n                           str_replace_all(Sys.Date(), \"-\", \"\"),  #Sys.Date() gives us the date of analysis. Str_replace_all() removes all hyphens \n                           \".png\"),                               # Finally we add the ending which is the file type\n       plot = boxplot_age)\n```\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"No ill\",\n  answer = \"Ill\",\n  \"Impossible to know from this boxplot\"\n)\n\n\ncat(\"QUESTION: Which group (ill or not ill) has more variation around age's median?\", longmcq(opts))\n\n```\n:::\n\n### **Step 4: Descriptive analysis**\n\nNow that we have explored and cleaned our data, we can start with the descriptive analysis. As you know, we normally describe the data by time, person and place. We won't do the \"place\" analysis because in this outbreak, that element is not relevant.\n\n#### Step 4.2: Analysis by time\n\n**Task**: Generate an epidemic curve with the dates of onset. Display in the x-axis each day of the study period.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou should be able, by now, to create the histogram required for this epicurve. For the x-axis breaks, remember there are two distinct elements in a `ggplot()`. Inside `geom_histogram()` we can specify the `binwidth =` of the bins to the unit we want (e.g, 1 for daily, 7 for weekly etc.). This will change the whole epicurve. \nThe second element is the scale. Scales change the way the axis or the colours are displayed, but the epicurve remains the same. In this case, as we want to modify the X-axis which is a date, we should use the function `scale_x_date()` and specify inside that we want `date_breaks =` by \"day\".\nIf you are struggling, have a look at the [Epicurves](https://epirhandbook.com/new_pages/epicurves.html#epicurves-with-ggplot2) chapter of the EpiRhandbook.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  ggplot(mapping = aes(x = dateonset)) + \n  \n  geom_histogram(binwidth = 1,             # we assign the width of the bins to one day\n                 color = \"darkgreen\",      # color of lines around bars\n                 fill = \"lightgreen\" )  +  # color of fill within bars \n  \n  scale_x_date(date_breaks = \"day\") +      # we want each day to be shown in the x-axis\n  \n  labs(\n    title = \"Epicurve of cases by date of onset\",\n    y = \"Number of cases\",\n    x = \"\"                                 # we leave x-axis title blank because we already say in title it is date of onset\n  ) +\n  \n  theme_bw() +                             # predefined theme\n  \n  theme(axis.text.x = element_text(angle = 90)) # we change the angle of the days in the x-axis so it is readble. Important this happens at the end\n\n  \n```\n\n</br>\n\n</details>\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"48h\",\n  \"A week later\",\n  answer = \"24h\",\n  \"The day of the party\"\n)\n\n\ncat(\"QUESTION: How long after the party was the peak day in cases?\", longmcq(opts))\n\n```\n:::\n\n#### Step 4.3: Analysis by person\n\n**Task**: Generate 2-by-2 tables with sex and age group by illness status\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nThere are several approaches to generate descriptive tables and cross-tabulations. You could use `tabyl()` from {janitor}, which is a very fast approach; or you could use `group_by()` in combination with `summarise()`, from {dplyr} which is the most flexible. In this case, however, we show you the solution with a very efficient approach: `tbl_summary()` from {gtsummary}\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  select(sex, age_group, ill) %>%  # we select the columns we're interested in\n  \n  tbl_summary(by = ill, percent = \"column\") # we assign the grouping column and define that we want the percentages by column\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"51%\",\n  \"49%\",\n  \"45%\",\n  \"80%\"\n)\n\n\ncat(\"QUESTION: What percentage of ill cases was female?\", longmcq(opts))\n\n```\n:::\n\n### **Step 5: Develop and test hypothesis**\n\nIn the previous step we have described the number of ill attendees by date of onset, and we have described how sex and age were distributed according to illness status. The next step in an outbreak investigation would be to develop and test hypothesis about the possible source of the outbreak.\n\n#### Step 5.1: Compute food-specific attack rates and % of cases exposed\n\n**Task**: Create 2 by 2 tables with exposure and outcome and calculate the attack rates.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could use the same approach we used before with `tbl_summary()` from {gtsummary}, but to calculate attack rates, you'll need to change from column to row percentages.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  select(tira, wmousse, dmousse, wmousse, beer, \n         redjelly, fruitsalad, tomato, mince, salmon,\n         horseradish, chickenwin, roastbeef, pork, ill) %>% # we select the columns we're interested in\n  \n  tbl_summary(by = ill, percent = \"row\") %>% #we assign the grouping column and define that we want the percentages by row\n  \n  add_overall()    # we add the overall counts\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"39%\",\n  \"25%\",\n  \"78%\",\n  answer = \"68%\"\n)\n\n\ncat(\"QUESTION: What is the attack rate in those who ate white mousse?\", longmcq(opts))\n\n```\n:::\n\n\n#### Step 5.2: Estimate the relative risk of the different exposures\n\nWe have calculated attack rates in exposed and unexposed, which already gives us a lot of information. For example, we see little difference in the attack rates of those who ate and did not ate salmon; but we observe a much higher attack rate among those who ate tiramisu, than among those who did not eat it. We also see a higher attack rate in those who did not drink beer than in those who drank it.\n\nTo have a better understanding of the exposures, we will now calculate relative risks.\n\n**Task**: First, estimate the relative risk for the exposure of having eaten white mousse at the dinner\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could do this manually, but you could use the function `riskratio()` from the package {epitools}, which will give you a lot of interesting information, besides the RR and its 95%CI. In this function, you need first to write the exposure and then the predictor. Try reading the documentation of the function if you have any doubts.\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n# Relative risk wmousse\nriskratio(tira_clean$wmousse, tira_clean$ill)\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"2.1\",\n  \"179\",\n  answer = \"2.8\",\n  \"1.0\"\n  )\n\n\ncat(\"QUESTION: What is the risk of illness among those who ate white mousse compared to those who did not have this food ?\", longmcq(opts))\n\n```\n:::\n\n**Task**: Calculate now the risk ratio for all the other exposures to develop hypothesis of the possible source\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could write the `riskratio()` function changing the exposure variable one by one. However, to save time, avoid making errors and being more efficient, you could try to use approaches that allow you to apply the same function to many different objects (e.g., multiple columns) simultaneously. There are different options for this such as *loops*, *lapply* or *purrr*. Here we give the solution with *purrr*, so if you want to explore further purrr have a look at the dedicated [section](https://epirhandbook.com/new_pages/iteration.html#iter_purrr) in the EpiRhandbook.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  select(-uniquekey, -age, -age_group, -sex, -dateonset, -ill) %>% # we first remove the columns we're not interested + the outcome column\n  map(.f = ~riskratio(.x, tira_clean$ill))     # here we call the function for each column. \".x\" represents all the columns in the database that have not been removed previously\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"beer\",\n  answer = \"tiramisu\",\n  \"pork\",\n  \"dark mousse\"\n  )\n\n\ncat(\"QUESTION: Which exposure has the highest risk ratio?\", longmcq(opts))\n\n```\n:::\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer =\"beer\",\n  \"tiramisu\",\n  \"pork\",\n  \"dark mousse\"\n  )\n\ncat(\"QUESTION: Which of the following seems like a protective factor?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"beer\",\n  \"tiramisu\",\n  answer = \"pork\",\n  \"dark mousse\"\n  )\n\ncat(\"QUESTION: Which of the following has a non-significant association?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"Yes\",\n  \"No\"\n  )\n\ncat(\"QUESTION: Is there a dose-response in the association between illness and tiramisu?\", longmcq(opts))\n\n```\n:::\n\nSeveral food items seemed to be associated with the occurrence of illness; **tiramisu, dark and white chocolate mousse, fruit salad, and red jelly**. They can potentially explain up to 94, 76, 49, 46, and 45 of the 103 cases, respectively. Investigators decided to identify their respective roles in the occurrence of illness. There also seems to be a **dose-response** in the amount of tiramisu eaten, with those eating 2 or more portions having a higher risk than those eating only 1 (who had a higher risk than those who did not eat tiramisu)\n\nFrom the crude analysis, epidemiologists noticed that the occurrence of **gastroenteritis was lower among those attendants who had drunk beer.** They also decided to assess if beer had a protective effect on the occurrence of gastroenteritis.\n\n#### Step 5.3: Confounding and effect modification\n\nThe finding that beer had a protective effect on GI illness is surprising. One of your colleagues suggested that tiramisu might be confounding this association. Given that tiramisu has the highest risk ratio, it might be that the dessert is associated with the outcome (causes it) and to the exposure (those drinking beer might have preferred not to ruin its sour flavour with the sweetness of tiramisu). Another colleague disagrees and thinks that, actually, tiramisu might be an effect modifier in the relation between beer and illness.\n\nQUESTION: How would you check if tiramisu is a confounder or an effect modifier in the association between beer and illness? \n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\nTo check both things: confounding and effect modification, we should stratify our data by tiramisu consumption. Once stratified, we can calculate risk ratios in both strata and an adjusted risk ratio: **the adjusted Mantel‚ÄìHaenszel risk ratio**. If this risk ratio is very different from the crude risk ratio (the overall risk ratio between beer and illness), we could say that tiramisu is confounding the association between beer and illness. We normally define as \"very different\" when: $(RRcrude/RRadjusted - 1)*100$ is larger than 10-20% difference (no strict threshold, your interpretation and expertise counts!).\n\nIf there is confounding but no effect modification, the adjusted M-H risk ratio should be different from the crude RR, but **the risk ratios in each strata -tiramisu yes and tiramisu no- should not be significantly different**. If they are significantly different then there is **effect modification**. How do we know if they are significantly different? We can run a test to tell us that called **the Mantel‚ÄìHaenszel test of homogeneity**.\n</br>\n\n</details>\n\n\n\n\n**Task**: Check if tiramisu is a confounder or an effect modifier in the association between beer and illness\n\nTry doing this task with the function `epi.2by2()` from the {epiR} package. **Read very carefully the documentation of the function**. Pay special attention at how the data needs to be structured. Read the hint if you are struggling\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nUnfortunately `epi.2by2()` is a very \"picky\" function. Although you can pass data into `epi.2by2()` in different formats, the easiest way is to create a new data frame grouped by the three columns that we will use: tira, beer and ill. \nYou could pass this new dataframe into `epi.2by2()` and it may work, but be careful. `epi.2by2()` will consider as *exposed* and as *ill* the first levels of your factor data, as per the image they have in the documentation and that we show you below:\n\n![](../images/stengen/epi.2by2_data.png)\nNow run this line of code `riskratio(tira_clean$beer, tira_clean$ill)` and look at the first part of the output. You should see something like this:\n\n![](../images/stengen/beer_data_before.png)\n\nAs you see, in the top left (96) we have unexposed who did not become ill, but in the previous image we saw that `epi.2by2()` will consider those in the top left (a) as exposed and ill. How to overcome this? The trick is to change the levels of the factor variables. By default, they have \"0\" as first level and \"1\" as second level. So, we can add a line that changes  the order of the levels before we groups the data (See the solution if you don't know what its meant)\n\n\n</br>\n\n</details>\n\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n### Group the dataframe\ngroup_data <- tira_clean %>% \n  mutate(across(.cols = c(tira, beer, ill), .fns = ~factor(.x, levels = c(1,0)))) %>% # we change the order of the levels\n  group_by(tira, beer, ill) %>% # it's important to group them in this order: strata, exposure, outcome\n  summarise(n = n()) \n\n### Run the function to obtain M-H estimates\nstrat_analysis <- epi.2by2(dat = group_data, method = \"cohort.count\",  # the method specifies that we are dealing with a cohort study\n           conf.level = 0.95, outcome = \"as.columns\")                  # we set up confidence intervals to 95 and we specify that the outcome variable is a column in the data\n#Print the results\nstrat_analysis\n```\n\n</br>\n\n</details>\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"13%\",\n  \"87%\",\n  \"30%\",\n  \"20%\"\n  )\n\ncat(\"QUESTION: Look at the results, what's the magnitude of the difference between the adjusted MH risk ratio and the crude one?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"No\",\n  \"Yes\"\n  )\n\ncat(\"QUESTION: Look at the results, is tiramisu an effect modifier in the association between beer and illness?\", longmcq(opts))\n\n```\n:::\n\nYou got several results. Let's now review them to make sense of them:\n\nThe first part is a table in which you get the overall table for the association between beer and illness.\nThe second part, titled *Point estimates and 95% CIs:* has different estimates depending on whether you're interested in risk ratios, odds ratios or attributable risks. As we are carrying out a cohort study, we're interested in the ones for **risk ratios**.\n\n-   **Inc risk ratio (crude)**: The crude incidence risk ratio, comparing the risk of the outcome between exposed and unexposed groups, with 95% confidence intervals. In this case, this is the overall risk of illness in those who drank beer compared to those who did not drink it.\n\n-   **Inc risk ratio (M-H):** The Mantel-Haenszel adjusted incidence risk ratio, accounting for stratification by tiramisu, with 95% confidence intervals.\n\n-   **Inc risk ratio (crude:M-H):** The ratio of the crude incidence risk ratio to the Mantel-Haenszel adjusted incidence risk ratio.\n\n\nThis is all we need to evaluate confounding. As we said before, we need to evaluate if the crude and the adjusted risk ratios are very different. We said that we can do that with the formula $(RRcrude/RRadjusted - 1)*100$. Here, the **Inc risk ratio (crude:M-H):** corresponds to the first part: $RRcrude/RRadjusted$. So we need to substract 1 and multiple by 100: (0.87-1)*100. If you do that you'll get 13%, which is borderline, but we can say that tiramisu is not massively confounding the association between beer and illness.\n\nTo know whether there is effect modification, you can check the **M-H test of homogeneity of IRRs** in the lower part of the results. As it is not significant (p = 0.713), we can conclude there is no effect modification of tiramisu on the association between beer and illness.\n\n\n\n\n","srcMarkdownNoYaml":"\n\n# An Outbreak of Gastroenteritis in Stegen, Germany (ENG) {.unnumbered} \n\n## Overview {.unnumbered}\n\n| **Case study characteristics** |                           |\n|--------------------------------|:--------------------------|\n| Name:                          | An Outbreak of Gastroenteritis in Stegen, Germany   |\n| Language:                      | English                   |\n| Tool:                          | R;                         |\n| Location:                      | Germany                   |\n| Scale:                         | Local                  |\n| Diseases:                      | GI                       |\n| Keywords:                      | GI; Stratified analysis; R |\n| Technical complexity:          | Intermediate              |\n| Methodological complexity:     | Basic              |\n# \n\n***Authorship***\\\nOriginal authors: This case study was first designed by Alain Moren and\nGilles Desve for EPIET. It is based on an investigation conducted by\nAnja Hauri, RKI, Berlin, 1998.\\\nData source: Data is fictional and was inspired by [Nygren et al.\nTick-borne encephalitis: acute clinical manifestations and severity in\n581 cases from Germany, 2018-2020. Journal of Infection. 2023 Apr\n1;86(4):369-75](https://linkinghub.elsevier.com/retrieve/pii/S0163-4453(23)00088-9)\\\nAdapted and modified by: Alicia Barrasa (EPIET), Ioannis Karagiannis\n(Public Health England - PHE), Giri Shankar (Public Health Wales),\nNiklas Willrich (Robert Koch Institute-RKI), Patrick Keating (Austrian\nAgency for Health and Food Safety-AGES), Alexander Spina (AGES), Daniel\nGardiner (PHE), Lukas Richter (AGES), Liese Van Gompel (MedEPIET),  Kostas Danis (MedEPIET) and Alberto Mateo Urdiales\n(Istituto Superiore di Sanit√† - ISS)\\\n\n## Instructions\n\n### Getting Help\n\nThere are several ways to get help:\n\n1)  Look for the \"hints\" and solutions (see below)\n2)  Post a question in [Applied Epi\n    Community](www.community.appliedepi.org) with reference to this case\n    study\n\n### Hints and Solutions\n\nHere is what the \"helpers\" look like:\n\n<!--Note that this is the way of including hints and explanations to the solutions -->\n\n```{=html}\n<!--\nNOTE: Below is the hint (all within details tags collapsed)\n-->\n```\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nHere you will see a helpful hint!\n\n</br>\n\n</details>\n\n```{=html}\n<!--\nNOTE: Below is the solution (all within details tags collapsed)\n-->\n```\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\n```{r eval = F, echo=T}\nebola_linelist %>% \n  filter(\n    age > 25,\n    district == \"Bolo\"\n  )\n```\n\nHere is more explanation about why the solution works.\n\n</br>\n\n</details>\n\n```{=html}\n<!--\nNOTE: End of solution\n-->\n```\n<!-- NOTE ABOUT SOLUTIONS: When using {webexercises} the solution will be automatically highlighted, so you can change (if appropriate) the feature \"Click here to see the solution\" to  \"Click here to see the explanation of the solution\" -->\n\n#### Posting a question in the Community Forum\n\n... description here about posting in Community... TO BE COMPLETED BY\nAPPLIED EPI\n\n#### Terms of Use\n\n**Disclaimer**: The information presented in this exercise and the\nassociated data files have been deliberately changed so as to facilitate\nthe acquisition of the learning objectives for fellows of EPIET, EUPHEM\nand EPIET-associated programmes. This case study was first introduced in\n2022 (see Copyright and Licence agreement for more information).\n\nYou are free:\n\n-   to Share: to copy and distribute the work\n-   to Remix: to adapt and build upon the material\n\nUnder the following conditions:\n\n-   Attribution: You must attribute the work in the manner specified by\n    the author or licensor (but not in any way that suggests that they\n    endorse you or your use of the work). The best way to do this is to\n    keep as it is the list of contributors: sources, authors and\n    reviewers.\n\n-   Share Alike: If you alter, transform, or build upon this work, you\n    may distribute the resulting work only under the same or similar\n    license to this one. Your changes must be documented. Under that\n    condition, you are allowed to add your name to the list of\n    contributors.\n\n-   Notification: If you use the work in the manner specified by the\n    author or licensor, [Walter\\@rki.de](mailto:Walterj@rki.de)\n\n-   You cannot sell this work alone but you can use it as part of a\n    teaching.\n\nWith the understanding that:\n\n-   Waiver: Any of the above conditions can be waived if you get\n    permission from the copyright holder.\n\n-   Public Domain: Where the work or any of its elements is in the\n    public domain under applicable law, that status is in no way\n    affected by the license.\n\n-   Other Rights: In no way are any of the following rights affected by\n    the license:\n\n    -   Your fair dealing or fair use rights, or other applicable\n        copyright exceptions and limitations;\n\n    -   The author's moral rights;\n\n    -   Rights other persons may have either in the work itself or in\n        how the work is used, such as publicity or privacy rights.\n\n-   Notice: For any reuse or distribution, you must make clear to others\n    the license terms of this work by keeping together this work and the\n    current license.\n\nThis licence is based on\n<http://creativecommons.org/licenses/by-sa/3.0/>\n\n### Feedback & suggestions\n\n-   You can write feedback and suggestions on this case study at the\n    [GitHub issues page](https://github.com/appliedepi/case_studies)\n-   Alternatively email us at:\n    [contact\\@appliedepi.org](mailto:contact@appliedepi.org)\n\n\\pagebreak\n\n### Version and revisions\n\nWrite date of first version\n\nWrite any revisions made to the case study\n\n| Date | Changes made                                                                                                                                                                                                                                       |                                                                                                                                    Author |\n|---------------------|:-------------------------------|------------------:|\n| 2015 | The case study has been divided in two parts: the first includes descriptive, univariable and stratified analysis as pre-module homework; the second includes logistic and binary regression (not shown here). Unnecessary toponymes were removed. |                                                               Alicia Barrasa (EPIET) and Ioannis Karagiannis (Publich Health England-PHE) |\n| 2017 | Questions were rephrased to reflect real life scenarios (rather than academic exercise)                                                                                                                                                            |                                                                         Alicia Barrasa (EPIET) and Giri Shankar (Public Health Wales-PHW) |\n| 2017 | The case study was adapted to include the help on R                                                                                                                                                                                                | Niklas Willrich (Robert Koch Institute-RKI), Patrick Keating (Austrian Agency for Health and Food Safety-AGES) and Alexander Spina (AGES) |\n|2017| Contribution to the R code|Daniel Gardiner (Public Health England-PHE) and Lukas Richter (AGES)|\n|2022|Minor revisions to the R code and explanations| |\n|2023| Major revision of the R code. R code was simplified and R tidyverse code was implemented| Liese Van Gompel (MedEPIET)|\n|2024| Revision of the R code, i.e. use of EpiStas package for univariable and multivariable analysis, simplification and harmonisation of the R code| Kostas Danis (MediPIET)|\n| 2017 | Revision of content, structure, R code and adaptation of format to Applied Epi's template of case studies | Alberto Mateo Urdiales (ISS) |\n\n\\pagebreak\n\n## Guidance\n\n### Objectives of this case study\n\nAt the end of this case study, participants should:\n\n-   know and be able to perform the fundamental steps of a descriptive statistical analysis of a foodborne outbreak (including quantitative assessment (frequency distributions, missing values, means/medians/modes, quartiles/SDs) and visualization of the data (histogram, boxplot))\n\n-   be able to perform univariate statistical analysis to identify potential vehicles of a foodborne outbreak (including risk ratios and/or odds ratios, depending on the design)\n\n-   know why and how stratification can be conducted in datasets related to an outbreak investigation\n\n-   be able to conduct a stratified analysis with respect to potential risk factors and confounders/effect modifiers\n\n\n### Previous level of expertise assumed\n\nParticipants are expected to be familiar with data management and basic analysis in R.\n\n### Preparation for the case study\n\n1.  Download folder named *stengen_mva* and extract contents in the local\n    laptop\n\n2.  Create an Rstudio project in the folder *stengen_mva* If you are unsure on\n    how to do that, read the EpiRhandbook Chapter on [R\n    projects](https://epirhandbook.com/en/new_pages/r_projects.html)\n\n3.  Inside the folder *stengen_mva*: Subfolder \"data\" contains a raw data\n    file named *tira.csv*. This is the only data file you will use in\n    this case study. In the same folder you can find the **data dictionary** with\n    a description of the dataframe variables.\n    \n4.  Subfolder scripts should be used to save any scripts related to the\n    analysis. Inside \"backup\" you will find a solution script with the\n    code of the case study named *stengen_analysis_backup.R*. \n\n5.  Subfolder \"outputs\" could be used to store all outputs (tables,\n    graphs, documents) that are the result of the analysis\n\n\n# **Part 1 - Scenario, study design and analysis plan**\n## Introduction \n\nOn 26 June 1998, the St Sebastian High School in Stegen (school A), Germany, celebrated a graduation party, where 250 to 350 participants were expected. Attendees included graduates from that school, their families and friends, teachers, 12th grade students and some graduates from a nearby school (school B).\n\nA self-service party buffet was supplied by a commercial caterer in Freiburg. Food was prepared on the day of the party and transported in a refrigerated van to the school.  \n\nFestivities started with a dinner buffet which opened from 8:30 pm onwards and were followed by a dessert buffet offered from 10 pm. The party and the buffet extended late during the night and alcoholic beverages were quite popular. All agreed it was a party to be remembered.\n\n\n## The alert\n\nOn 2nd July 1998, the Freiburg local health office reported to the Robert Koch Institute (RKI) in Berlin the occurrence of many cases of gastroenteritis following the graduation party described above. More than 100 cases were suspected among attendees and some of them were admitted to nearby hospitals. Sick people suffered from fever, nausea, diarrhoea and vomiting that lasted for several days. Most believed that the tiramisu consumed at dinner was responsible for their illness. Salmonella Enteritidis was isolated from 19 stool samples. \n\nThe Freiburg health office sent a team to investigate the kitchen facilities of the caterer. Food preparation procedures were reviewed. Food samples, except tiramisu (none was left over), were sent to the laboratory of Freiburg University. Microbiological analyses were performed on samples of the following: brown chocolate mousse, caramel cream, remoulade sauce, yoghurt dill sauce and 10 raw eggs.  \n \nThe Freiburg health office requested help from the RKI in the investigation to assess the magnitude of the outbreak and identify potential vehicle(s) and risk factors for transmission in order to better control the outbreak.\n\n\n## The study\n\nCases were defined as any person who had attended the party at St Sebastian High School who suffered from diarrhoea (‚â• 3 loose stool for 24 hours) between 27 June and 29 June 1998; or who suffered from at least three of the following symptoms: vomiting, fever ‚â•38.5¬∞C, nausea, abdominal pain, and headache.\n\nStudents from both schools attending the party were asked through phone interviews to provide names of persons who attended the party. \n\nOverall, 291 responded to enquiries and 103 cases were identified (attack rate: 35%). Among these cases, 84 (82%) received medical treatment and four were admitted to hospitals. Attack rates by age group were 36.6% for persons <20 years, 32.1% for persons 20 to 29 years, and 36.8% for persons older than 29 years. \n\n![Figure 1: Cases of gastroenteritis by time of onset among attendees of a high-school graduation ceremony (n=103), Germany, June 1998](../images/stengen/figure1.png)\n\n\n**QUESTION 1**. What would be your hypothesis concerning the source of the outbreak?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\nThe shape of the epidemic curve and the attendance to a single event (a buffet) pointed towards a foodborne outbreak related to a **point source of infection.**\n\n</br>\n\n</details>\n\n\n**QUESTION 2**. What study design would you choose to test this hypothesis?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\nUsing the updated list of attendants, a **retrospective cohort study** including all attendants to the party (that could be reached) was conducted. All had received a standard questionnaire asking for demographic information, signs, symptoms and duration, admission to hospital, and food and beverages consumption at the party including amount consumed. Food-specific attack rates were computed for more than 50 food items and beverages.\n\n\n</br>\n\n</details>\n\n**Question 3**. What would your overall plan of analysis be?\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see the solution\n\n</summary>\n\n</br>\n\n**Perform data cleaning**\n\n-   For each variable, look at the range, unexpected and missing values.\n\n-   Correct data using the original forms used if needed \n\n**Describe each variable**\n\n-   For each variable, describe frequency distributions including missing values and, if needed, means, median, modes, quartiles, standard deviation, outliers \n\n-   Make appropriate histograms and box plots\n\n-   Choose relevant characteristics to describe the population\n\n**Identify the outbreak vehicle if any**\n\n-   Calculate food-specific attack rates\n\n-   Look at the proportions of cases exposed\n\n-   Chose the appropriate measure of association\n\n-   Chose the appropriate statistical tests and significance level\n\n-   Calculate the percentages of cases exposed to each exposure\n\n-   Search for any dose-response relationship if appropriate\n\n-   Interpret the results\n\n**Perform a stratified analysis**\n\n-   Identify the variables that are potential effect modifiers (EM) and confounders\n\n-   Design appropriate stratification tables\n\n-   Stratify on each level taken by the EM and confounders\n\n-   Compute appropriate measurements to identify confounding and effect modification\n\n-   Conduct appropriate statistical tests\n\n-   Interpret the results\n\n**Perform a multivariable analysis**\n\n-   This will be discussed during the module.\n\n</br>\n\n</details>\n\n\n\n\n# **Part 2 - Descriptive, univariate and stratified analysis with R**\n\n### **Step 1: Set up**\n\n#### Step 1.1: Create a new R script\n\nOnce you have created an Rproject inside the \"stengen_mva\" folder (as\nspecified in the second point of the section **Preparation for the case\nstudy**). Create a new script with the name *stengen_analysis* and save it in the\nsubfolder \"scripts\". If you are familiar with Rmarkdown, you may decide\nto use this type of file instead of a standard R script.\n\n#### Step 1.2: Define R language\n\nDepending on where you are and how you carried out R installation, your\nlanguage \"locale\" might be different from the language of the graphs\nthat you want to produce. For example, a french person might have a\nfrench \"locale\". If that is the case, when creating a graph by day of\nthe week, Monday will be displayed as \"lundi\". If that french person\nwants to create an English report, as for this case study, the language\n\"locale\" should be changed.\n\n**Task**: Ensure your \"locale\" is in English and change it into English\nif it is not. If you don't know how to do this try finding it online\n(searching for online help is an important skill for R users!).\nOtherwise, see the solution below\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, results = 'hide'}\n# To see your language locale\nSys.getlocale()\n\n# To change it into English\nSys.setlocale(\"LC_ALL\", \"English\")\n\n```\n\n</br>\n\n</details>\n\n#### Step 1.3: Install/load packages\n\nInstall and load the following packages: rio, skimr, janitor, gtsummary,\nrstatix, epitools, epiR, epikit and tidyverse.\n\nYou can find more about installing/loading packages in the\n[Packages](https://epirhandbook.com/en/new_pages/basics.html#packages)\nsection of the EpiRhandbook.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou may end up using a long list of packages. Unfortunately different\npackages have functions with the same name. For example, the package\n{dplyr} (already installed with {tidyverse}) has a function called\n`select()` which we frequently use to subset columns of a data frame.\nBut other packages such as {MASS} do also have a function called\n`select()`. This could create headaches if you want to subset columns\nusing dplyr's `select()` but R thinks you're calling MASS's `select()`\n(we call this masking - `dplyr::select()` is masked by\n`MASS::select()`). Given that you are more likely to use functions from\n{tidyverse}, ensure that this is the last package in your `p_load()`\nlist so that functions from {tidyverse} (including {dplyr} functions)\nwill always \"prevail\".\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, results = 'hide'}\n# Ensures the package \"pacman\" is installed\nif (!require(\"pacman\")) {\n     install.packages(\"pacman\") }\n\npacman::p_load(\n  \n  rio,             # to import datasets\n  skimr,           # for displaying your data\n  janitor,         # a package for data cleaning\n  gtsummary,       # to create frequency tables\n  rstatix,         # to generate summary statistics\n  epitools,        # for univariable analysis\n  epikit,          # for creating age categories\n  epiR,            # for the adjusted risk ratios across strata\n  tidyverse  # data management and visualization\n)\n\n```\n\n</br>\n\n</details>\n\n### **Step 2: Import and explore data**\n\n```{r, include=FALSE}\ntira_raw <- import(\"../case_studies_to_translate/ENG/stengen_mva/data/tira.csv\")\n```\n\n#### Step 2.1: Import the data \n\n**Task** Import the data frame called \"tira.csv\" inside the \"data\" subfolder. \n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nIf you are working within a project, finding the path to the dataframe\nshould be relatively straightfoward. A \".csv\" file is a \"Comma-separated Values\" file.\nYou can import this dataframe using the `read.csv()` which comes already pre-installed in R.\nHowever, we recommend that you use the **`import()`** function\nfrom {rio} because, as you may remember, this function will recognise\nthe file type and import it whether the file is from R, Stata, excel or\nmany others. If you have any doubts about importing review the [Import\nand\nexport](https://epirhandbook.com/en/new_pages/importing.html#import-data)\nchapter of the EpiRhandbook.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, eval=FALSE}\n# Import the dataset 'tira.csv'  \ntira_raw <- import(\"data/tira.csv\") \n```\n\n\n</br>\n\n</details>\n\n\n\n#### Step 2.2: Explore the data \n\n**Task**: Explore the data trying to answer the following questions:\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"522 and 8\",\n  \"2 and 345\",\n  answer = \"291 and 20\",\n  \"600 and 23\"\n)\n\n\ncat(\"QUESTION: How many rows and columns does the dataframe have?\", longmcq(opts))\n\n```\n:::\n\n\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"8\",\n  \"14\",\n  \"1\",\n  \"0\"\n)\n\n\ncat(\"QUESTION: How many cases have 'age' missing?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"factor\",\n  answer = \"integer\",\n  \"character\",\n  \"logical\"\n)\n\n\ncat(\"QUESTION: What is the class of the column 'salmon'?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"83%\",\n  \"70%\",\n  answer = \"29%\",\n  \"6%\"\n)\n\n\ncat(\"QUESTION: What percentage of attendees ate tomato?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"factor\",\n  \"character\",\n  answer = \"date\",\n  \"numeric\"\n)\n\n\ncat(\"QUESTION: What is the class of the column 'dateonset'?\", longmcq(opts))\n\n```\n:::\n\n::: {.webex-check}\n\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"As 'NA'\",\n  \"As empy spaces\",\n  \"With an 'Unknown' cateogry\",\n  answer = \"With the number 9\"\n)\n\n\ncat(\"QUESTION: How are missing categorised in the variables 'salmon', 'horseradish' and 'pork'?\", longmcq(opts))\n\n```\n:::\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nAn efficient way to explore data is to use the function `skim()` from the {skimr} package, as it gives you all the information needed with only one command. Of course, there are several alternatives. You can also have a look at `glimpse()` from {dplyr}, for example.\nAn easy way to explore single variables that have categories is to use `tabyl()` from {janitor}\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\n# Inspect your dataset and generate basic statistics using the skim function  \nskim(tira_raw)\n# Glimpse is an alternative to skim which gives more accurate information about the nature of the  variables\nglimpse(tira_raw)\n# To see the different categories of the variables\ntabyl(tira_raw, tomato)\n\n```\n\n\n</br>\n\n</details>\n\n\n#### Step 2.3: Explore age in more detail \n\n**Task** Explore the age of attendees by: \n\n- Getting summary statistics\n\n- Generating a boxplot of age by illness status.\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can create a boxplot with {ggplot2} by using the geom `geom_boxplot()`.  In order to create two boxes, one for each illness status, you can assign in the aesthetics the column *ill* to both the x-axis and the fill. Don't worry if it doesn't look good right now....it should look like the solution below. If you need a refresher on how ggplot works, have a look at the EpiRhandbook [Chapter](https://epirhandbook.com/new_pages/ggplot_basics.html)\n\n</br>\n\n</details>\n\n\n\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE, warning=TRUE}\n## Generate summary statistics \nsummary(tira_raw$age)\n\n### Creating a boxplot of age by illness status\nboxplot_age <- tira_raw %>% \n  \n  ggplot(mapping = aes(x = ill,\n                       y = age,\n                       fill = ill)) + \n  \n  geom_boxplot() + \n  \n  labs(\n    title = \"Boxplot: Age distribution per illness status\",\n    x = \"Disease status\",\n    y = \"Age\",\n    fill = \"Illness (0=No;1=Yes)\"\n  ) +\n  \n  theme_bw()\n\nboxplot_age\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"No ill\",\n  \"Ill\",\n  answer = \"Impossible to know from this boxplot\"\n)\n\n\ncat(\"QUESTION: Which group (ill or not ill) has more variation around age's median?\", longmcq(opts))\n\n```\n:::\n\nWe were not able to create the boxplot that we aimed for. In fact, you can see that a warning message appeared in your console saying: \"Did you forget to specify a `group` aesthetic or to convert a numerical variable into a factor?\"\n\nLooks like all columns that consist of 1 (present) and 0 (absent) values are of class 'integer', including \"ill\". Integer means that they are considered numbers. However, we want them to be categories, otherwise we won't be able to carry out many of the analysis we want (including this boxplot). So, now we'll sort this out alongside other cleaning operations.  \n\n### **Step 3: Clean the data**\n\n#### Step 3.1: Transform categorical variables\n**Task**: Change all present (1) / absent (0) variables from integer to factors. Do the same for the variables that record the number of portions eaten.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can do this one by one, or you could do all at the same time using the `across()` function from {dplyr}. If you are not sure how to use the `across()` function, read the section on [Transform multiple columns](https://epirhandbook.com/en/new_pages/cleaning.html#clean_across) from the EpiRhandbook.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x)))\n\n\n# Check that the changes have been succesful\nglimpse(tira_clean)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.2: Categorise \"missing\" as NA\nWe saw with the `skim()` overview -and in the data dictionary- that the variables *salmon*, *pork* and *horseradish* have 'missing' codified with number '9'. In most analysis and visualisations, it is very important that R considers missing data truly as \"missing\". To do that, missing data needs to be coded as NA (**without quotes**). Other codifications of missing data, such as empty spaces or the number 9 (as in this case) will mean that R will treat this data as a category or a number. For R, 9 is not different from number 1.\n\n**Task** Recode the columns salmon, pork and horseradish so that values of 9 are coded as NA. Add the new code to the cleaning pipeline initiated in the previous step\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nFor this task you can use the `mutate()` function in combination with `recode()` or `if_else()`. The former is used specifically for recoding, whereas the latter is used to create/modify columns based on logical conditions. In any case, functions like `if_else()` and `recode()` may require you to specify the type of NA (e.g., NA_character_, NA_real_, NA_integer_) to ensure that the resulting vector maintains a consistent data type. This is important because R is strongly typed, meaning that each vector must contain elements of the same type.\nIf you want to know more about recoding, read the EpiRhandbook section on [Recoding](https://epirhandbook.com/new_pages/cleaning.html#re-code-values). Regardless of the approach that you choose, add it to the cleaning pipe command you started before, so that your code is tidy.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_)))\n\n\n# Check that the changes have been succesful\ntabyl(tira_clean, pork)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.3: Re-categorise mousse and tiramisu portions\nWe saw that there are two columns -*tportion* and *mportion*- that have four categories according to the number of portions eaten. However, exploring these columns we can see that few people ate 3 portions. The low number in this category means that it will be very difficult to have meaningful results due to the wide uncertainty that we'll find in the estimates.\n\n**Task**: Re-categorise these columns so that they have three categories: 0,1 and 2+ portions eaten. Add the new code to the cleaning pipeline initiated previously. \n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nWe will now use the `mutate()` function in combination with `if_else()`. As specified above, this function is used for simple logical recoding, which is what we want to do now. There are three \"partner\" functions called `if_else()` from {dplyr}, `ifelse()` from {base} and `fifelse()` from {data.table}. They all have the same syntax. `ifelse()` has the advantage of being embedded in R, which guarantees its stability and sustainability. `if_else()` has some advantages compared to `ifelse()` that are important in epi analysis. For example, it does not convert Date objects to numeric (which can be a headache) and verifies that both alternatives in the if and else statements are of the same class. Finally, `fifelse()` is the fastest, so it has its advantages when we're analysis a large database.\n\nIf you want to know more about simple logical recoding, have a look at the dedicated [section](https://epirhandbook.com/new_pages/cleaning.html#ifelse-and-if_else) of the EpiRhandbook.\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\n#Check portion before\ntabyl(tira_clean, tportion)\ntabyl(tira_clean, mportion)\n\n#Run cleaning pipe line with new code\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_))) %>% \n  \n  # simple logical recoding with if_else()\n  mutate(across(.cols = c(tportion, mportion), .fns = ~if_else(.x == \"3\" | .x == \"2\", \"2+\", .x)))\n\n\n#Check portion after to verify changes\ntabyl(tira_clean, tportion)\ntabyl(tira_clean, mportion)\n```\n\n\n</br>\n\n</details>\n\n#### Step 3.4: Create age groups\n\n\n**Task**: Create a new variable with two categories (those aged < age's median and those >=age's median). **Add the code to create this new variable to the cleaning command you created above to ensure your code is tidy. Do not write multiple cleaning commands**\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou can  create the age group column with the function `age_categories()` from {epikit}. If you're not familiar with this function, try looking in the *Help* on how it works, or read the specific EpiRhandbook [Section](https://epirhandbook.com/new_pages/cleaning.html#age_categories)\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\n```{r , echo=TRUE}\ntira_clean <- tira_raw %>% # tira_clean will be out clean dataframe after we have performed cleaning tasks on tira_raw\n  \n  # this would be changing one-by-one the columns into factors\n  mutate(ill = as.factor(ill)) %>% \n  \n  # this would change all columns we are interested into 'factors' in only one command\n  mutate(across(.cols = !c(uniquekey, dateonset, age), # with the exclamation mark before c() we are telling R that we want all columns, except those in the c() list, to be transformed into factors\n                .fns = ~ as.factor(.x))) %>% \n  \n  # we can do all columns at the same time with across(). Here we use recode for this example \n  mutate(across(.cols = c(salmon, horseradish, pork), .fns = ~ recode(.x, \"9\" = NA_character_))) %>% \n  \n  # simple logical recoding with if_else()\n  mutate(across(.cols = c(tportion, mportion), .fns = ~if_else(.x == \"3\" | .x == \"2\", \"2+\", .x))) %>% \n  \n  # create age categories\n  mutate(age_group = age_categories(age,           # the column to use to create the cateogories \n                                    lower = 0,     # the lower value\n                                    upper = 20,    # the upper value (we want a group of 20+)\n                                    by = 20))      # as we only want two groups, this is also 20\n\n\n\n# Check that the changes have been succesful\ntabyl(tira_clean, age_group)\n```\n\n\n</br>\n\n</details>\n\n\n\n\n\n#### Step 3.5: Re-create the boxplot\n**Task**: Create the boxplot we tried in **Step 2.3** using the clean version of the data. Save the boxplot in the subfolder \"outputs\".\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n## Boxplot of age by illness status\nboxplot_age <- tira_clean %>% \n  \n  ggplot(mapping = aes(x = ill,\n                       y = age,\n                       fill = ill)) + \n  \n  geom_boxplot() + \n  \n  labs(\n    title = \"Boxplot: Age distribution per disease status\",\n    x = \"Disease status\",\n    y = \"Age\",\n    fill = \"Illness (0=No;1=Yes)\"\n  ) +\n  \n  theme_bw()\n\nboxplot_age\n```\n\n```{r, echo=TRUE, eval=FALSE}\n\n### Save the boxplot\n#### A static way of saving it\nggsave(filename = \"outputs/boxplot_age.png\", plot = boxplot_age)\n#### A dynamic way of doing it so that it contains the date of the analysis\nggsave(filename = str_glue(\"outputs/boxplot_age_\",             #First we write the beginning of the file name until the date \n                           str_replace_all(Sys.Date(), \"-\", \"\"),  #Sys.Date() gives us the date of analysis. Str_replace_all() removes all hyphens \n                           \".png\"),                               # Finally we add the ending which is the file type\n       plot = boxplot_age)\n```\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"No ill\",\n  answer = \"Ill\",\n  \"Impossible to know from this boxplot\"\n)\n\n\ncat(\"QUESTION: Which group (ill or not ill) has more variation around age's median?\", longmcq(opts))\n\n```\n:::\n\n### **Step 4: Descriptive analysis**\n\nNow that we have explored and cleaned our data, we can start with the descriptive analysis. As you know, we normally describe the data by time, person and place. We won't do the \"place\" analysis because in this outbreak, that element is not relevant.\n\n#### Step 4.2: Analysis by time\n\n**Task**: Generate an epidemic curve with the dates of onset. Display in the x-axis each day of the study period.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou should be able, by now, to create the histogram required for this epicurve. For the x-axis breaks, remember there are two distinct elements in a `ggplot()`. Inside `geom_histogram()` we can specify the `binwidth =` of the bins to the unit we want (e.g, 1 for daily, 7 for weekly etc.). This will change the whole epicurve. \nThe second element is the scale. Scales change the way the axis or the colours are displayed, but the epicurve remains the same. In this case, as we want to modify the X-axis which is a date, we should use the function `scale_x_date()` and specify inside that we want `date_breaks =` by \"day\".\nIf you are struggling, have a look at the [Epicurves](https://epirhandbook.com/new_pages/epicurves.html#epicurves-with-ggplot2) chapter of the EpiRhandbook.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  ggplot(mapping = aes(x = dateonset)) + \n  \n  geom_histogram(binwidth = 1,             # we assign the width of the bins to one day\n                 color = \"darkgreen\",      # color of lines around bars\n                 fill = \"lightgreen\" )  +  # color of fill within bars \n  \n  scale_x_date(date_breaks = \"day\") +      # we want each day to be shown in the x-axis\n  \n  labs(\n    title = \"Epicurve of cases by date of onset\",\n    y = \"Number of cases\",\n    x = \"\"                                 # we leave x-axis title blank because we already say in title it is date of onset\n  ) +\n  \n  theme_bw() +                             # predefined theme\n  \n  theme(axis.text.x = element_text(angle = 90)) # we change the angle of the days in the x-axis so it is readble. Important this happens at the end\n\n  \n```\n\n</br>\n\n</details>\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"48h\",\n  \"A week later\",\n  answer = \"24h\",\n  \"The day of the party\"\n)\n\n\ncat(\"QUESTION: How long after the party was the peak day in cases?\", longmcq(opts))\n\n```\n:::\n\n#### Step 4.3: Analysis by person\n\n**Task**: Generate 2-by-2 tables with sex and age group by illness status\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nThere are several approaches to generate descriptive tables and cross-tabulations. You could use `tabyl()` from {janitor}, which is a very fast approach; or you could use `group_by()` in combination with `summarise()`, from {dplyr} which is the most flexible. In this case, however, we show you the solution with a very efficient approach: `tbl_summary()` from {gtsummary}\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  select(sex, age_group, ill) %>%  # we select the columns we're interested in\n  \n  tbl_summary(by = ill, percent = \"column\") # we assign the grouping column and define that we want the percentages by column\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"51%\",\n  \"49%\",\n  \"45%\",\n  \"80%\"\n)\n\n\ncat(\"QUESTION: What percentage of ill cases was female?\", longmcq(opts))\n\n```\n:::\n\n### **Step 5: Develop and test hypothesis**\n\nIn the previous step we have described the number of ill attendees by date of onset, and we have described how sex and age were distributed according to illness status. The next step in an outbreak investigation would be to develop and test hypothesis about the possible source of the outbreak.\n\n#### Step 5.1: Compute food-specific attack rates and % of cases exposed\n\n**Task**: Create 2 by 2 tables with exposure and outcome and calculate the attack rates.\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could use the same approach we used before with `tbl_summary()` from {gtsummary}, but to calculate attack rates, you'll need to change from column to row percentages.\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  \n  select(tira, wmousse, dmousse, wmousse, beer, \n         redjelly, fruitsalad, tomato, mince, salmon,\n         horseradish, chickenwin, roastbeef, pork, ill) %>% # we select the columns we're interested in\n  \n  tbl_summary(by = ill, percent = \"row\") %>% #we assign the grouping column and define that we want the percentages by row\n  \n  add_overall()    # we add the overall counts\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"39%\",\n  \"25%\",\n  \"78%\",\n  answer = \"68%\"\n)\n\n\ncat(\"QUESTION: What is the attack rate in those who ate white mousse?\", longmcq(opts))\n\n```\n:::\n\n\n#### Step 5.2: Estimate the relative risk of the different exposures\n\nWe have calculated attack rates in exposed and unexposed, which already gives us a lot of information. For example, we see little difference in the attack rates of those who ate and did not ate salmon; but we observe a much higher attack rate among those who ate tiramisu, than among those who did not eat it. We also see a higher attack rate in those who did not drink beer than in those who drank it.\n\nTo have a better understanding of the exposures, we will now calculate relative risks.\n\n**Task**: First, estimate the relative risk for the exposure of having eaten white mousse at the dinner\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could do this manually, but you could use the function `riskratio()` from the package {epitools}, which will give you a lot of interesting information, besides the RR and its 95%CI. In this function, you need first to write the exposure and then the predictor. Try reading the documentation of the function if you have any doubts.\n\n</br>\n\n</details>\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n# Relative risk wmousse\nriskratio(tira_clean$wmousse, tira_clean$ill)\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"2.1\",\n  \"179\",\n  answer = \"2.8\",\n  \"1.0\"\n  )\n\n\ncat(\"QUESTION: What is the risk of illness among those who ate white mousse compared to those who did not have this food ?\", longmcq(opts))\n\n```\n:::\n\n**Task**: Calculate now the risk ratio for all the other exposures to develop hypothesis of the possible source\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nYou could write the `riskratio()` function changing the exposure variable one by one. However, to save time, avoid making errors and being more efficient, you could try to use approaches that allow you to apply the same function to many different objects (e.g., multiple columns) simultaneously. There are different options for this such as *loops*, *lapply* or *purrr*. Here we give the solution with *purrr*, so if you want to explore further purrr have a look at the dedicated [section](https://epirhandbook.com/new_pages/iteration.html#iter_purrr) in the EpiRhandbook.\n</br>\n\n</details>\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\ntira_clean %>% \n  select(-uniquekey, -age, -age_group, -sex, -dateonset, -ill) %>% # we first remove the columns we're not interested + the outcome column\n  map(.f = ~riskratio(.x, tira_clean$ill))     # here we call the function for each column. \".x\" represents all the columns in the database that have not been removed previously\n```\n\n</br>\n\n</details>\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"beer\",\n  answer = \"tiramisu\",\n  \"pork\",\n  \"dark mousse\"\n  )\n\n\ncat(\"QUESTION: Which exposure has the highest risk ratio?\", longmcq(opts))\n\n```\n:::\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer =\"beer\",\n  \"tiramisu\",\n  \"pork\",\n  \"dark mousse\"\n  )\n\ncat(\"QUESTION: Which of the following seems like a protective factor?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  \"beer\",\n  \"tiramisu\",\n  answer = \"pork\",\n  \"dark mousse\"\n  )\n\ncat(\"QUESTION: Which of the following has a non-significant association?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"Yes\",\n  \"No\"\n  )\n\ncat(\"QUESTION: Is there a dose-response in the association between illness and tiramisu?\", longmcq(opts))\n\n```\n:::\n\nSeveral food items seemed to be associated with the occurrence of illness; **tiramisu, dark and white chocolate mousse, fruit salad, and red jelly**. They can potentially explain up to 94, 76, 49, 46, and 45 of the 103 cases, respectively. Investigators decided to identify their respective roles in the occurrence of illness. There also seems to be a **dose-response** in the amount of tiramisu eaten, with those eating 2 or more portions having a higher risk than those eating only 1 (who had a higher risk than those who did not eat tiramisu)\n\nFrom the crude analysis, epidemiologists noticed that the occurrence of **gastroenteritis was lower among those attendants who had drunk beer.** They also decided to assess if beer had a protective effect on the occurrence of gastroenteritis.\n\n#### Step 5.3: Confounding and effect modification\n\nThe finding that beer had a protective effect on GI illness is surprising. One of your colleagues suggested that tiramisu might be confounding this association. Given that tiramisu has the highest risk ratio, it might be that the dessert is associated with the outcome (causes it) and to the exposure (those drinking beer might have preferred not to ruin its sour flavour with the sweetness of tiramisu). Another colleague disagrees and thinks that, actually, tiramisu might be an effect modifier in the relation between beer and illness.\n\nQUESTION: How would you check if tiramisu is a confounder or an effect modifier in the association between beer and illness? \n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n\nTo check both things: confounding and effect modification, we should stratify our data by tiramisu consumption. Once stratified, we can calculate risk ratios in both strata and an adjusted risk ratio: **the adjusted Mantel‚ÄìHaenszel risk ratio**. If this risk ratio is very different from the crude risk ratio (the overall risk ratio between beer and illness), we could say that tiramisu is confounding the association between beer and illness. We normally define as \"very different\" when: $(RRcrude/RRadjusted - 1)*100$ is larger than 10-20% difference (no strict threshold, your interpretation and expertise counts!).\n\nIf there is confounding but no effect modification, the adjusted M-H risk ratio should be different from the crude RR, but **the risk ratios in each strata -tiramisu yes and tiramisu no- should not be significantly different**. If they are significantly different then there is **effect modification**. How do we know if they are significantly different? We can run a test to tell us that called **the Mantel‚ÄìHaenszel test of homogeneity**.\n</br>\n\n</details>\n\n\n\n\n**Task**: Check if tiramisu is a confounder or an effect modifier in the association between beer and illness\n\nTry doing this task with the function `epi.2by2()` from the {epiR} package. **Read very carefully the documentation of the function**. Pay special attention at how the data needs to be structured. Read the hint if you are struggling\n\n<details>\n\n<summary style=\"text-decoration: underline; color: darkgreen;\">\n\n`r fontawesome::fa(\"lightbulb\", fill = \"gold\")` Click to read a hint\n\n</summary>\n\n</br>\n\nUnfortunately `epi.2by2()` is a very \"picky\" function. Although you can pass data into `epi.2by2()` in different formats, the easiest way is to create a new data frame grouped by the three columns that we will use: tira, beer and ill. \nYou could pass this new dataframe into `epi.2by2()` and it may work, but be careful. `epi.2by2()` will consider as *exposed* and as *ill* the first levels of your factor data, as per the image they have in the documentation and that we show you below:\n\n![](../images/stengen/epi.2by2_data.png)\nNow run this line of code `riskratio(tira_clean$beer, tira_clean$ill)` and look at the first part of the output. You should see something like this:\n\n![](../images/stengen/beer_data_before.png)\n\nAs you see, in the top left (96) we have unexposed who did not become ill, but in the previous image we saw that `epi.2by2()` will consider those in the top left (a) as exposed and ill. How to overcome this? The trick is to change the levels of the factor variables. By default, they have \"0\" as first level and \"1\" as second level. So, we can add a line that changes  the order of the levels before we groups the data (See the solution if you don't know what its meant)\n\n\n</br>\n\n</details>\n\n\n\n<details>\n\n<summary style=\"text-decoration: underline; color: red;\">\n\n`r fontawesome::fa(\"check\", fill = \"red\")`Click to see a solution (try\nit yourself first!)\n\n</summary>\n\n</br>\n```{r, echo=TRUE}\n### Group the dataframe\ngroup_data <- tira_clean %>% \n  mutate(across(.cols = c(tira, beer, ill), .fns = ~factor(.x, levels = c(1,0)))) %>% # we change the order of the levels\n  group_by(tira, beer, ill) %>% # it's important to group them in this order: strata, exposure, outcome\n  summarise(n = n()) \n\n### Run the function to obtain M-H estimates\nstrat_analysis <- epi.2by2(dat = group_data, method = \"cohort.count\",  # the method specifies that we are dealing with a cohort study\n           conf.level = 0.95, outcome = \"as.columns\")                  # we set up confidence intervals to 95 and we specify that the outcome variable is a column in the data\n#Print the results\nstrat_analysis\n```\n\n</br>\n\n</details>\n\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"13%\",\n  \"87%\",\n  \"30%\",\n  \"20%\"\n  )\n\ncat(\"QUESTION: Look at the results, what's the magnitude of the difference between the adjusted MH risk ratio and the crude one?\", longmcq(opts))\n\n```\n:::\n\n::: webex-check\n```{r, results=\"asis\", echo=FALSE}\npacman::p_load(webexercises)\n\nopts <- c(\n  answer = \"No\",\n  \"Yes\"\n  )\n\ncat(\"QUESTION: Look at the results, is tiramisu an effect modifier in the association between beer and illness?\", longmcq(opts))\n\n```\n:::\n\nYou got several results. Let's now review them to make sense of them:\n\nThe first part is a table in which you get the overall table for the association between beer and illness.\nThe second part, titled *Point estimates and 95% CIs:* has different estimates depending on whether you're interested in risk ratios, odds ratios or attributable risks. As we are carrying out a cohort study, we're interested in the ones for **risk ratios**.\n\n-   **Inc risk ratio (crude)**: The crude incidence risk ratio, comparing the risk of the outcome between exposed and unexposed groups, with 95% confidence intervals. In this case, this is the overall risk of illness in those who drank beer compared to those who did not drink it.\n\n-   **Inc risk ratio (M-H):** The Mantel-Haenszel adjusted incidence risk ratio, accounting for stratification by tiramisu, with 95% confidence intervals.\n\n-   **Inc risk ratio (crude:M-H):** The ratio of the crude incidence risk ratio to the Mantel-Haenszel adjusted incidence risk ratio.\n\n\nThis is all we need to evaluate confounding. As we said before, we need to evaluate if the crude and the adjusted risk ratios are very different. We said that we can do that with the formula $(RRcrude/RRadjusted - 1)*100$. Here, the **Inc risk ratio (crude:M-H):** corresponds to the first part: $RRcrude/RRadjusted$. So we need to substract 1 and multiple by 100: (0.87-1)*100. If you do that you'll get 13%, which is borderline, but we can say that tiramisu is not massively confounding the association between beer and illness.\n\nTo know whether there is effect modification, you can check the **M-H test of homogeneity of IRRs** in the lower part of the results. As it is not significant (p = 0.713), we can conclude there is no effect modification of tiramisu on the association between beer and illness.\n\n\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"html_document","warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":false,"css":["../webex.css","webex.css"],"include-after-body":["../webex.js","webex.js"],"output-file":"stengen-en.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","published-title":"Last updated","lightbox":true,"babelquarto":{"languagecodes":[{"name":"es","text":"Espa√±ol"},{"name":"en","text":"English"}],"mainlanguage":"en","languages":["es"]},"title-es":"Estudios de casos de AppliedEpi","bibliography":["../references.bib"],"theme":{"light":"cosmo","dark":["darkly","../theme-dark.scss"]},"number-depth":0,"editor_options":{"chunk_output_type":"console"},"editor":{"markdown":{"wrap":72}},"title":"![](../images/ecdc/logo_epiet_rki.png){width=12in}\n"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}